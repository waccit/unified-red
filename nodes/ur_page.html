<script type="text/javascript">
    // convert to i18 text
    function c_ur_page(x) {
        return RED._('unified-red/ur_page:ur_page.' + x);
    }

    RED.nodes.registerType('ur_page', {
        category: 'config',
        defaults: {
            name: { value: c_ur_page('label.default') },
            // icon: { value: 'folder' },
            folder: { type: 'ur_folder', required: true },
            order: { value: 0 },
            disp: { value: true },
            width: { value: 6 },
            collapse: { value: false },
            disabled: { value: false },
            hidden: { value: false },
            isMulti: { value: false },
            expression: {
                value: '',
                validate: function (v) {
                    if (!this.isMulti) {
                        return true;
                    } else {
                        let expression = v || '';
                        let validLen = v.length > 0;
                        let validExp = v.toLowerCase().includes('{x}');
                        let valid = validLen && validExp;

                        if (!validLen) {
                            $('#length-invalid').css({ display: 'block' });
                        } else {
                            $('#length-invalid').css({ display: 'none' });
                        }

                        if (!validExp) {
                            $('#expression-invalid').css({ display: 'block' });
                        } else {
                            $('#expression-invalid').css({ display: 'none' });
                        }

                        $('#node-config-input-expression').toggleClass('input-error', !valid);

                        return valid;
                    }
                },
            },
            instances: {
                value: [
                    {
                        names: {
                            input: '',
                            _arr: [],
                        },
                        param: {
                            input: [{ variable: '', values: '' }],
                            _arr: [],
                        },
                    },
                ],
            },
        },
        sort: function (A, B) {
            if (A.folder !== B.folder) {
                var folderA = RED.nodes.node(A.folder);
                var folderB = RED.nodes.node(B.folder);
                if (!folderA && folderB) {
                    return -1;
                } else if (folderA && !folderB) {
                    return 1;
                } else {
                    return folderA.order - folderB.order;
                }
            }
            return A.order - B.order;
        },
        paletteLabel: 'dashboard page',
        label: function () {
            var folderNode = RED.nodes.node(this.folder);
            if (folderNode) {
                return (
                    '[' + (folderNode.name || c_ur_page('label.folder')) + '] ' + (this.name || c_ur_page('label.page'))
                );
            }
            return '[' + c_ur_page('label.unassigned') + '] ' + (this.name || c_ur_page('label.page'));
        },
        // labelStyle: function() { return this.name?"node_label_italic":""; },
        oneditprepare: function () {
            $('#node-config-input-disabled-btn').on('click', function (e) {
                var i = $(this).find('i');
                var active = i.hasClass('fa-toggle-on');
                var newCls = 'fa fa-toggle-' + (active ? 'off' : 'on');
                i.attr('class', newCls);
                $('#node-config-input-disabled').prop('checked', active);

                var newTxt = c_ur_page(active ? 'label.disabled' : 'label.enabled');
                $('#node-config-input-disabled-label').text(newTxt);

                var info = $('#node-config-input-disabled-info');
                var done = active ? info.show() : info.hide();
            });
            if (this.disabled) {
                $('#node-config-input-disabled-btn').click();
            } else {
                $('#node-config-input-disabled-label').text(c_ur_page('label.enabled'));
            }

            $('#node-config-input-hidden-btn').on('click', function (e) {
                var i = $(this).find('i');
                var active = i.hasClass('fa-toggle-on');
                var newCls = 'fa fa-toggle-' + (active ? 'off' : 'on');
                i.attr('class', newCls);
                $('#node-config-input-hidden').prop('checked', active);

                var newTxt = c_ur_page(active ? 'label.hidden' : 'label.visible');
                $('#node-config-input-hidden-label').text(newTxt);

                var info = $('#node-config-input-hidden-info');
                var done = active ? info.show() : info.hide();
            });
            if (this.hidden) {
                $('#node-config-input-hidden-btn').click();
            } else {
                $('#node-config-input-hidden-label').text(c_ur_page('label.visible'));
            }

            $('#node-config-input-isMulti-btn').on('click', function (e) {
                var i = $(this).find('i');
                var disabled = i.hasClass('fa-toggle-off');
                var newCls = 'fa fa-toggle-' + (disabled ? 'on' : 'off');
                i.attr('class', newCls);
                $('#node-config-input-isMulti').prop('checked', disabled);

                var newTxt = c_ur_page(disabled ? 'label.enabled' : 'label.disabled');
                $('#node-config-input-isMulti-label').text(newTxt);

                // if disabled toggle "on"
                if (disabled) {
                    $('#instance-expression').show();
                    $('#instances-map').show();
                } else {
                    $('#instance-expression').hide();
                    $('#instances-map').hide();
                }

                var info = $('#node-config-input-isMulti-info');
                var done = disabled ? info.show() : info.hide();
            });
            if (this.isMulti) {
                $('#node-config-input-isMulti-btn').click();
            } else {
                $('#node-config-input-isMulti-label').text(c_ur_page('label.disabled'));
                $('#instance-expression').hide();
                $('#instances-map').hide();
            }

            $('#node-config-input-instance-expressions-list')
                .css('min-height', '150px')
                .editableList({
                    sortable: true,
                    removable: true,
                    addButton: true,
                    addItem: function (container, index, opt) {
                        if (!opt.hasOwnProperty('instance')) {
                            opt.instance = {
                                names: { input: '', _arr: [] },
                                param: { input: [], _arr: [] },
                            };
                        }

                        let instance = opt.instance;

                        let rawInstanceNames = instance.names.input || '';
                        let arrInstanceNames = [...rawToArr(rawInstanceNames)];

                        container.css({
                            overflow: 'hidden',
                            whitespace: 'nowrap',
                        });

                        var row = $('<div/>')
                            .css({ display: 'flex', 'justify-content': 'space-evenly' })
                            .appendTo(container);

                        var instNamesInputField = $('<input/>', {
                            class: 'node-config-input-instance-name',
                            id: 'instance-name-' + index,
                            type: 'text',
                            style: 'width: 40%',
                            placeholder: 'instance name',
                        })
                            .appendTo(row)
                            .val(rawInstanceNames);

                        var addInstanceParamBtn = $(
                            '<a href="#" class="editor-button-small" style="align-self: flex-end"> <i class="fa fa-plus"></i></a>'
                        ).css({ 'text-align': 'center', padding: '0' });

                        addInstanceParamBtn.on('click', function (evt) {
                            instanceParamField.editableList('addItem', {});
                            evt.stopPropagation();
                            evt.preventDefault();
                        });

                        var instanceParamField = $('<ol>', {
                            class: 'node-config-input-instance-parameters-list',
                            id: 'node-config-input-instance-parameters-list-' + index,
                        })
                            .appendTo(row)
                            .editableList({
                                header: $('<div>')
                                    .append(
                                        $.parseHTML(
                                            '<div id="instance-param-field-header" style="color: #5d5d5d; font-size: 14px;">instance parameters</div>'
                                        )
                                    )
                                    .append(addInstanceParamBtn)
                                    .css({ display: 'flex', padding: '6px 8px', 'justify-content': 'space-between' }),
                                addButton: false,
                                removable: true,
                                height: 'auto',
                                connectWith: '.node-config-input-instance-parameter',
                                addItem: function (container, i, parameter) {
                                    container.css({ padding: '0' });

                                    let idx = i;

                                    if (!parameter.hasOwnProperty('input')) {
                                        parameter.input = [{ variable: '', values: '' }];
                                        idx = 0;
                                    }

                                    let param = parameter;

                                    let rawValues = param.input[idx].values;
                                    let arrValues = rawToArr(rawValues);

                                    var paramRow = $('<div>', {
                                        class: 'node-input-instance-parameter-' + index + '-' + i,
                                    })
                                        .css({ display: 'flex', 'justify-content': 'space-evenly', padding: 0 })
                                        .appendTo(container);

                                    var instParamVarInputField = $('<input/>', {
                                        class: 'node-config-input-instance-parameter-variable',
                                        id: 'instance-parameter-variable-' + index + '-' + i,
                                        type: 'text',
                                        // style: 'width: 43%; font-size: 10px',
                                        placeholder: 'variable',
                                    })
                                        .appendTo(paramRow)
                                        .val(param.input[idx].variable);

                                    var instParamValInputField = $('<input/>', {
                                        class: 'node-config-input-instance-parameter-value',
                                        id: 'instance-parameter-values-' + index + '-' + i,
                                        type: 'text',
                                        // style: 'width: 43%; font-size: 10px',
                                        placeholder: 'values',
                                    })
                                        .appendTo(paramRow)
                                        .val(param.input[idx].values);

                                    instNamesInputField
                                        .add(instParamValInputField)
                                        .on('change keyup paste', function () {
                                            rawInstanceNames = instNamesInputField.val();
                                            rawValues = instParamValInputField.val();

                                            arrInstanceNames = rawToArr(rawInstanceNames);
                                            arrValues = rawToArr(rawValues);

                                            let valid =
                                                arrInstanceNames.length !== 0 &&
                                                arrValues.length !== 0 &&
                                                arrInstanceNames.length === arrValues.length;

                                            instNamesInputField.toggleClass('input-error', !valid);
                                            instParamValInputField.toggleClass('input-error', !valid);
                                            $(
                                                '#node-config-input-instance-expressions-list .red-ui-editableList-header'
                                            ).toggleClass('input-error', !valid);
                                        });
                                },
                            });

                        if (instance.param && instance.param.input.length > 0) {
                            let size = instance.param.input.length;
                            for (let i = 0; i < size; i++) {
                                $('#node-config-input-instance-parameters-list-' + index).editableList(
                                    'addItem',
                                    instance.param
                                );
                            }
                        }
                    },
                });

            if (this.instances) {
                for (let i = 0; i < this.instances.length; i++) {
                    $('#node-config-input-instance-expressions-list').editableList('addItem', {
                        instance: this.instances[i],
                    });
                }
            }
        },
        oneditsave: function () {
            this.disabled = $('#node-config-input-disabled').prop('checked');
            this.hidden = $('#node-config-input-hidden').prop('checked');
            this.isMulti = $('#node-config-input-isMulti').prop('checked');

            let instances = $('#node-config-input-instance-expressions-list').editableList('items');
            let node = this;

            node.instances = [];

            instances.each(function (index, inst) {
                let container = $(this);

                let parameters = $('#node-config-input-instance-parameters-list-' + index).editableList('items');

                let rawNames = container.find('#instance-name-' + index).val();
                let namesArr = rawToArr(rawNames);

                let rawParams = [];
                let paramsArr = [];

                // build rawParams
                parameters.each((i, p) => {
                    let rawParamVar = $(this)
                        .find('#instance-parameter-variable-' + index + '-' + i)
                        .val();
                    let rawParamVals = $(this)
                        .find('#instance-parameter-values-' + index + '-' + i)
                        .val();

                    rawParams.push({ variable: rawParamVar, values: rawParamVals });
                });

                // build paramsArr
                namesArr.forEach((n, i) => {
                    let paramObj = {};

                    parameters.each((ii, p) => {
                        let rawParamVar = $(this)
                            .find('#instance-parameter-variable-' + index + '-' + ii)
                            .val();
                        let rawParamVals = rawToArr(
                            $(this)
                                .find('#instance-parameter-values-' + index + '-' + ii)
                                .val()
                        );

                        paramObj[rawParamVar] = rawParamVals[i];
                    });

                    paramsArr.push(paramObj);
                });

                let i = {
                    names: {
                        input: container.find('#instance-name-' + index).val(),
                        _arr: [...namesArr],
                    },
                    param: {
                        input: [...rawParams],
                        _arr: [...paramsArr],
                    },
                };

                node.instances.push(i);
            });
        },
    });

    var explodeRange = function (exp) {
        if (exp.indexOf('-') === -1) {
            return exp;
        }
        let [a, b] = exp.split('-');
        a = parseInt(a);
        b = parseInt(b);
        let start = Math.min(a, b);
        let end = Math.max(a, b);
        let range = [];
        while (start <= end) {
            range.push(start++);
        }
        return range.join(',');
    };

    var rawToArr = function (raw) {
        let result = [];
        let rawCopy = raw;

        rawCopy = rawCopy.split(/\s*\,\s*/).filter((x) => x);
        for (let i = 0; i < rawCopy.length; i++) {
            let temp = explodeRange(rawCopy[i]).split(',');
            if (temp.length !== 0) {
                result = result.concat(temp);
            }
        }

        return result;
    };
</script>

<script type="text/html" data-template-name="ur_page">
    <div class="form-row">
        <label for="node-config-input-name"
            ><i class="fa fa-tag"></i> <span data-i18n="ur_page.label.name"></span
        ></label>
        <input type="text" id="node-config-input-name" />
    </div>
    <div class="form-row">
        <label for="node-config-input-folder"
            ><i class="fa fa-folder-o"></i> <span data-i18n="ur_page.label.folder"></span
        ></label>
        <input type="text" id="node-config-input-folder" />
    </div>
    <div class="form-row">
        <label for="node-config-input-disabled-btn"
            ><i class="fa fa-ban"></i> <span data-i18n="ur_page.label.state"></span
        ></label>
        <button id="node-config-input-disabled-btn" class="editor-button" style="width:100px; margin-right:6px;">
            <i class="fa fa-toggle-on"></i> <span id="node-config-input-disabled-label"></span>
        </button>
        <input type="checkbox" id="node-config-input-disabled" style="display: none;" />
        <span
            id="node-config-input-disabled-info"
            data-i18n="[html]ur_page.info.disabled"
            style="display: none;"
        ></span>
    </div>
    <div class="form-row">
        <label for="node-config-input-hidden-btn"
            ><i class="fa fa-eye-slash"></i> <span data-i18n="ur_page.label.navmenu"></span
        ></label>
        <button id="node-config-input-hidden-btn" class="editor-button" style="width:100px; margin-right:6px;">
            <i class="fa fa-toggle-on"></i> <span id="node-config-input-hidden-label"></span>
        </button>
        <input type="checkbox" id="node-config-input-hidden" style="display:none;" />
        <span id="node-config-input-hidden-info" data-i18n="[html]ur_page.info.hidden" style="display:none;"></span>
    </div>
    <div class="form-row">
        <label for="node-config-input-isMulti-btn" style="display: inline-flex; align-items: center"
            ><i class="fa fa-clone" style="margin-right: 5px"></i> <span data-i18n="ur_page.label.multi-page"></span
        ></label>
        <button id="node-config-input-isMulti-btn" class="editor-button" style="width:100px; margin-right:6px;">
            <i class="fa fa-toggle-off"></i> <span id="node-config-input-isMulti-label"></span>
        </button>
        <input type="checkbox" id="node-config-input-isMulti" style="display:none;" />
        <span id="node-config-input-isMulti-info" data-i18n="[html]ur_page.info.isMulti" style="display:none;"></span>
    </div>
    <div class="form-row" id="instance-expression">
        <label for="node-config-input-expression" style="display: inline-flex; align-items: center"
            ><i class="fa fa-code" style="margin-right: 5px;"></i> <span data-i18n="ur_page.label.expression"></span
        ></label>
        <input type="text" id="node-config-input-expression" />
        <div
            id="length-invalid"
            style="display: none; font-size: 10px; line-height: 12px; color: red; padding-left: 105px; margin-top: -15px"
        >
            must provide expression
        </div>
        <div
            id="expression-invalid"
            style="display: none; font-size: 10px; line-height: 12px; color: red; padding-left: 105px;"
        >
            must include {x}
        </div>
    </div>
    <div class="form-row" id="instances-map">
        <label for="node-config-input-instances"
            ><i class="fa fa-tags"></i> <span data-i18n="ur_page.label.instances"></span
        ></label>
        <ol id="node-config-input-instance-expressions-list"></ol>
    </div>
    <div class="form-tips" data-i18n="[html]ur_page.tip"></div>
</script>

<script type="text/html" data-help-name="ur_page">
    <p>Page configuration for Unified-RED</p>
    <p>
        Configures a page in the menu to serve as an <em>endpoint</em> level node in the menu tree. May contain groups.
    </p>
    <p>
        <b>Disabled</b> pages are not included in the app, and are therefore not functional. The page name still appears
        in the Navigation Menu (unless it is also hidden).
    </p>
    <p>
        <b>Hidden</b> pages are not listed in the Left-hand Navigation Menu. However, they are still active in the app.
    </p>
</script>
