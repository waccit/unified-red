<style>
    input.series-color {
        width: 100px;
        text-align: center;
    }
    input.series-color::-webkit-color-swatch {
        border: none;
    }
</style>
<script type="text/javascript">
    RED.nodes.registerType('ur_chart',{
        category: 'unified-red',
        color: '#81c784',
        defaults: {
            name: {value: ''},
            group: {type: 'ur_group', required: true},
            order: {value: 0},
            width: {
                value: 0,
            },
            height: { value: 0 },
            label: {value: 'chart'},
            chartType: {value: 'line'},
            topic: {value: []},
            topics: {
                value: [
                    {
                        alias: '',
                        def: '',
                    },
                ],
            },
            legend: {value: 'false'},
            xformat: {value: 'HH:mm:ss'},
            interpolate: {value: 'linear', required:true},
            nodata: {value: ''},
            live: {value: false},
            xrange: {value: '', validate:function(value) { return value === '' || RED.validators.number(); }},
            xrangeunits: {value: '', validate:function(value) { return value === '' || RED.validators.number(); }},
            ymin: {value: '', validate:function(value) { return value === '' || RED.validators.number(); }},
            ymax: {value: '', validate:function(value) { return value === '' || RED.validators.number(); }},
            outputs: {value: 0}
        },
        inputs:1,
        outputs:0,
        // inputLabels: function() { return this.chartType; },
        align: "right",
        icon: "ur_chart.png",
        paletteLabel: 'chart',
        label: function() { return this.name || (~this.label.indexOf("{{") ? null : this.label) || 'chart'; },
        labelStyle: function() { return this.name?"node_label_italic":""; },
        oneditprepare: function() {
            if (!$("#node-input-chartType").val()) {
                $("#node-input-chartType").val("line");
            }
            if (this.useOldStyle === undefined) {
                $("#node-input-useOldStyle").prop('checked', true);
            }
            if (RED.nodes.getType('ur_group')) {
                $('.form-tips').hide();
            } else {
                $('.form-row').hide();
            }
            $("#node-input-size").elementSizer({
                width: '#node-input-width',
            });
            $("#node-input-chartType").on("change", function() {
                $("#legend-show").hide();
                if ($(this).val() === "line") {
                    $("#x-axis-show").show();
                    $("#x-axis-label-show").show();
                    $("#interpolate-show").show();
                    $("#legend-show").show();
                    $("#y-axis-show").show();
                    $("#hole-size-show").hide();
                    $("#show-live-topic").show();
                    $("#show-useOneColor").hide();
                }
                else {
                    $("#x-axis-show").hide();
                    $("#x-axis-label-show").hide();
                    $("#interpolate-show").hide();
                    $("#show-live-topic").hide();
                    if (($(this).val() === "bar")||($(this).val() === "horizontalBar")) {
                        $("#show-useOneColor").show();
                        $("#legend-show").show();
                    }
                    else {
                        $("#show-useOneColor").hide();
                    }
                    if ($(this).val() === "pie") {
                        $("#y-axis-show").hide();
                        $("#legend-show").show();
                        $("#hole-size-show").show();
                    }
                    else {
                        $("#y-axis-show").show();
                        $("#hole-size-show").hide();
                    }
                }
            });
            var oval = $("#node-input-xformat").val();
            if (!oval) { $("#node-input-xformat").val("HH:mm:ss"); }
            var odef = 'custom';
            if (oval === "HH:mm:ss") { odef = oval; }
            if (oval === "HH:mm") { odef = oval; }
            if (oval === "Y-M-D") { odef = oval; }
            if (oval === "D/M") { odef = oval; }
            if (oval === "dd HH:mm") { odef = oval; }
            if (oval === "auto") { odef = oval; }
            var ohms = {value:"HH:mm:ss", label:"HH:mm:ss", hasValue:false};
            var ohm = {value:"HH:mm", label:"HH:mm", hasValue:false};
            var oymd = {value:"Y-M-D", label:"Year-Month-Date", hasValue:false};
            var odm = {value:"D/M", label:"Date/Month", hasValue:false};
            var oahm = {value:"dd HH:mm", label:"Day HH:mm", hasValue:false};
            var ocus = {value:"custom", label:"custom", icon:"red/images/typedInput/az.png"};
            var oaut = {value:"auto", label:"automatic", hasValue:false};
            $("#node-input-xformat").typedInput({
                default: odef,
                types:[ ohms, ohm, oahm, odm, oymd, ocus, oaut ]
            });
            $('#node-input-topic-container')
                .css('min-height', '100px')
                .css('min-width', '950px')
                .editableList({
                    addItem: function (container, index, opt) {
                        if (!opt.hasOwnProperty('topic')) {
                            opt.topic = {};
                        }
                        var topic = opt.topic;
                        if (!topic.hasOwnProperty('prop')) {
                            topic.prop = 'vis';
                        }
                        container.css({
                            overflow: 'hidden',
                            whiteSpace: 'nowrap',
                        });
                        var row = $('<div/>').appendTo(container);
                        //alias input
                        $('<input/>', {
                            class: 'node-input-topic-alias',
                            type: 'text',
                            placeholder: 'alias',
                            style: 'margin-left: 5px; width: 45%;',
                        })
                            .appendTo(row)
                            .val(topic.alias);
                        //topic input
                        $('<input/>', {
                            class: 'node-input-topic-def',
                            type: 'text',
                            placeholder: 'topic',
                            style: 'margin-left: 5px; width: 45%;',
                        })
                            .appendTo(row)
                            .val(topic.def);
                    },
                    sortable: true,
                    removable: true,
                    addButton: true,
                });
            // $("#node-input-topic-container").editableList('addItems', this.topics);
            for (let i = 0; i < this.topics.length; i++) {
                $('#node-input-topic-container').editableList('addItem', { topic: this.topics[i] });
            }

        },
        oneditsave: function() {
            if ($("#node-input-xformat").typedInput('type') !== 'custom') {
                $("#node-input-xformat").val($("#node-input-xformat").typedInput('type'));
            }
            this.xmin = $("node-input-xmin").val();
            this.xmax = $("node-input-xmax").val();
            $('#node-input-live').is(':checked') ? (this.live = true) : (this.live = false);
            
            let topics = $('#node-input-topic-container').editableList('items');
            let node = this;
            node.topics = [];
            topics.each(function (i) {
                let container = $(this);

                let c = {
                    alias: container.find('.node-input-topic-alias').val(),
                    def: container.find('.node-input-topic-def').val(),
                };
                node.topics.push(c);
            });
        },
        oneditresize: function (size) {
            var rows = $('#dialog-form>div:not(.node-input-topic-container-row)');
            var height = size.height;
            for (var i = 0; i < rows.length; i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $('#dialog-form>div.node-input-topic-container-row');
            height -= parseInt(editorRow.css('marginTop')) + parseInt(editorRow.css('marginBottom'));

            $('#node-input-topic-container').editableList('height', height);
        },
    });
</script>

<script type="text/html" data-template-name="ur_chart">
    <div class="form-row">
        <label for="node-input-group"><i class="fa fa-table"></i> Group</label>
        <input type="text" id="node-input-group">
    </div>
    <div class="form-row">
        <label><i class="fa fa-object-group"></i> Size</label>
        <input type="hidden" id="node-input-width">
        <input type="hidden" id="node-input-height">
        <button class="editor-button" id="node-input-size"></button>
    </div>
    <div class="form-row">
        <label for="node-input-label"><i class="fa fa-i-cursor"></i> Label</label>
        <input type="text" id="node-input-label" placeholder="optional chart title">
    </div>
    <div class="form-row node-input-topic-container-row">
        <label for="node-input-width" style="vertical-align:top"><i class="fa fa-list-alt"></i> Topics</label>
        <div class="form-row node-input-topic-container-row">
            <ol id="node-input-topic-container"></ol>
        </div>
    </div>
    <div class="form-row">
        <label for="node-input-chartType"><i class="fa fa-line-chart"></i> Type</label>
        <select id="node-input-chartType" style="width:159px; font-family:'FontAwesome','Helvetica Neue', Helvetica, Arial, sans-serif">
            <option value="line">Line chart</option>
            <option value="table">Table</option>
        </select>
        <div id="show-live-topic" style="display:inline-block;">
            <input type="checkbox" id="node-input-live" style="display:inline-block; width:auto; vertical-align:baseline; margin-left:40px; margin-right:5px;">Live Chart
        </div>
    </div>
    <!-- <div class="form-row" id="x-axis-label-show">
        <label for="node-input-xformat">X-axis Label</label>
        <input type="text" id="node-input-xformat" style="width:268px;">
    </div> -->
    <div class="form-row">
        <label for="node-input-xrange">Range</label>
        <input type="number" id="node-input-xrange" style="width: 35%">
        <select id="node-input-xrangeunits" style="width: 35%">
            <option value="1">sec</option>
            <option value="60">min</option>
            <option value="3600">hr</option>
            <option value="86400">day(s)</option>
            <option value="2592000">month(s)</option>
            <option value="31104000">year(s)</option>
         </select>
    </div>
    <!-- <div class="form-row" id="x-axis-show">
        <label id="x-label-show" for="node-input-xmin">X-axis</label>
        <label for="node-input-xmin" style="width:auto">min</label>
        <input type="datetime-local" id="node-input-xmin" style="width: 32%">
        <label for="not-input-xmax" style="width:auto; margin-left:10px;">max</label>
        <input type="datetime-local" id="node-input-xmax" style="width: 31%">
    </div> -->
    <div class="form-row" id="y-axis-show">
        <label id="y-label-show" for="node-input-ymin">Y-axis</label>
        <label for="node-input-ymin" style="width:auto">min</label>
        <input type="text" id="node-input-ymin" style="width: 32%" placeholder="Auto">
        <label for="not-input-ymax" style="width:auto; margin-left:10px;">max</label>
        <input type="text" id="node-input-ymax" style="width: 31%" placeholder="Auto">
    </div>
    <div class="form-row" id="topic-pattern">
        <label for="node-input-topicPattern" style="display: inline-flex; align-items: center">
            <i class="fa fa-cogs" style="margin-right: 5px;"></i> Topic Pattern
        </label>
        <input type="text" id="node-input-topicPattern" />
    </div>
    <div class="form-row">
        <label for="node-input-access"><i class="fa fa-lock"></i> Access</label>
        <select id="node-input-access" style="width: 35%">
            <option value="">Default</option>
            <option value="1">Level 1 Viewer</option>
            <option value="2">Level 2 Limited Operator</option>
            <option value="3">Level 3 Standard Operator</option>
            <option value="4">Level 4 IT Operator</option>
            <option value="5">Level 5 Security Operator</option>
            <option value="6">Level 6 (reserved)</option>
            <option value="7">Level 7 (reserved)</option>
            <option value="8">Level 8 (reserved)</option>
            <option value="9">Level 9 Tech</option>
            <option value="10">Level 10 Admin</option>
         </select>
         <select id="node-input-accessBehavior" style="width: 35%">
            <option value="hide">Show/Hide</option>
            <option value="disable">Enable/Disable</option>
         </select>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
</script>

<script type="text/html" data-help-name="ur_chart">
    <p>Plots the input values on a chart. This can either be a time based line chart, a bar chart (vertical or horizontal),
    or a pie chart.</p>
    <p>Each input <code>msg.payload</code> value will be converted to a number. If the
    conversion fails, the message is ignored.</p>
    <p>Minimum and Maximum <b>Y</b> axis values are optional. The graph will auto-scale to any values received.</p>
    <p>Multiple series can be shown on the same chart by using a different <code>msg.topic</code>
    value on each input message. Multiple bars of the same series can be shown by using the <code>msg.label</code> property.</p>
    <p>The <b>X</b> axis defines a time window or a maximum number of points to display. Older data will be automatically removed from the graph.
    The axis labels can be formatted using a <a href="https://momentjs.com/docs/#/displaying/format/" target="_blank">
    Moment.js time formatted</a> string.</p>
    <p>Inputting a <code>msg.payload</code> containing a blank array <code>[]</code> will clear the chart.</p>
    <p>See <b><a href="https://github.com/node-red/node-red-dashboard/blob/master/Charts.md" target="_new">this information</a></b>
    for how to pre-format data to be passed in as a complete chart.</p>
    <p>The <b>Blank label</b> topic can be used to display some text before any valid data is received.</p>
    <p>The label can also be set by a message property by setting
    the topic to the name of the property, for example <code>{{msg.topic}}</code>.</p>
    <p>The node output contains an array of the chart state that can be persisted if needed. This can be passed
    into the chart node to re-display the persisted data.</p>
</script>
