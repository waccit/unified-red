<script type="text/javascript">
(function() {
    // convert to i18 text
    function c_(x) {
        return RED._("unified-red/ur_schedule:ur_schedule." + x);
    }

    RED.nodes.registerType('ur_schedule', {
        category: 'unified-red',
        color: '#FFCC66',
        defaults: {
            group: { type: 'ur_group', required: true },
            order: { value: 0 },
            width: { value: 12 },
            holidays: { type: 'ur_schedule_holidays_config', required: true },
            name: { value: '' },
            topic: { value: '', required: true },
            values: [],
            weekdays: [],
            dates: []
        },
        inputs: 1,
        outputs: 1,
        align: "left",
        icon: "font-awesome/fa-calendar",
        paletteLabel: 'schedule',
        label: function () { return this.name || 'schedule'; },
        labelStyle: function () { return this.name ? "node_label_italic" : ""; },
        oneditprepare: function () {
            let node = this;
            if (this.values == null) {
                this.values = [ { name: "On", value: 1 }, { name: "Off", value: 0 } ];
            }
            if (this.weekdays == null) {
                this.weekdays = [ /* { weekday:0, value: "On", hour: 12, minute: 0 }, { weekday:0, value: "Off", hour: 14, minute: 0 } */ ];
            }
            if (this.dates == null) {
                this.dates = [/* { date:"06/29", value: "On", hour: 12, minute: 0 }, { date:"06/29", value: "Off", hour: 14, minute: 0 } */ ];
            }
            $("#node-input-size").elementSizer({
                width: "#node-input-width",
                height: "#node-input-height",
                group: "#node-input-group"
            });

            $("#node-input-value-container").css('min-height', '160px').css('min-width', '450px').editableList({
                addItem: function (container, i, opt) {
                    if (!opt.hasOwnProperty('value')) {
                        opt.value = {};
                    }
                    var value = opt.value;
                    container.css({
                        overflow: 'hidden',
                        whiteSpace: 'nowrap'
                    });
                    var row = $('<div/>').appendTo(container);
                    // name field
                    $('<input/>', { class: "node-input-value-name", type: "text", placeholder: "name", style: "margin-left: 5px; width: 48%;" }).appendTo(row).val(value.name);
                    // value field
                    $('<input/>', { class: "node-input-value-value", type: "text", placeholder: "value", style: "margin-left: 5px; width: 48%;" }).appendTo(row).val(value.value);
                },
                sortable: true,
                removable: true
            });

            $("#node-input-weekday-container").css('min-height', '260px').css('min-width', '450px').editableList({
                addItem: function (container, i, opt) {
                    if (!opt.hasOwnProperty('event')) {
                        opt.event = {};
                    }
                    var event = opt.event;
                    container.css({
                        overflow: 'hidden',
                        whiteSpace: 'nowrap'
                    });
                    var row = $('<div/>').appendTo(container);
                    // weekday field
                    var weekdays = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
                    var weekdayField = $('<select/>', { class: "node-input-weekday-weekday", style: "margin-left: 5px; width: 32%;" }).appendTo(row);
                    for (let i in weekdays) {
                        $("<option>").val(i).text(weekdays[i]).appendTo(weekdayField);
                    }
                    weekdayField.val(event.weekday);
                    // value field
                    var valueField = $('<select/>', { class: "node-input-weekday-value", style: "margin-left: 5px; width: 33%;" }).appendTo(row);
                    for (let v of node.values) {
                        $("<option>").val(v.value).text(v.name).prop('selected', v.name == event.value).appendTo(valueField);
                    }
                    // hour field
                    var hourField = $('<select/>', { class: "node-input-weekday-hour", style: "margin-left: 5px; width: 15%;" }).appendTo(row);
                    for (let i = 0; i < 24; i++) {
                        $("<option>").val(i).text(i).appendTo(hourField);
                    }
                    hourField.val(event.hour);
                    // minute field
                    var minuteField = $('<select/>', { class: "node-input-weekday-minute", style: "margin-left: 5px; width: 15%;" }).appendTo(row);
                    for (let i = 0; i < 60; i++) {
                        $("<option>").val(i).text(i < 10 ? "0"+i : i).appendTo(minuteField);
                    }
                    minuteField.val(event.minute);
                },
                sortable: true,
                removable: true
            });

            $("#node-input-date-container").css('min-height', '260px').css('min-width', '450px').editableList({
                addItem: function (container, i, opt) {
                    if (!opt.hasOwnProperty('event')) {
                        opt.event = {};
                    }
                    var event = opt.event;
                    container.css({
                        overflow: 'hidden',
                        whiteSpace: 'nowrap'
                    });
                    var row = $('<div/>').appendTo(container);
                    // date field
                    $('<input/>', { class: "node-input-date-date", type: "text", placeholder: "Date (mm/dd)", style: "margin-left: 5px; width: 32%;" }).appendTo(row).val(event.date);
                    // value field
                    var valueField = $('<select/>', { class: "node-input-date-value", style: "margin-left: 5px; width: 33%;" }).appendTo(row);
                    for (let v of node.values) {
                        $("<option>").val(v.value).text(v.name).prop('selected', v.name == event.value).appendTo(valueField);
                    }
                    // hour field
                    var hourField = $('<select/>', { class: "node-input-date-hour", style: "margin-left: 5px; width: 15%;" }).appendTo(row);
                    for (let i = 0; i < 24; i++) {
                        $("<option>").val(i).text(i).appendTo(hourField);
                    }
                    hourField.val(event.hour);
                    // minute field
                    var minuteField = $('<select/>', { class: "node-input-date-minute", style: "margin-left: 5px; width: 15%;" }).appendTo(row);
                    for (let i = 0; i < 60; i++) {
                        $("<option>").val(i).text(i < 10 ? "0"+i : i).appendTo(minuteField);
                    }
                    minuteField.val(event.minute);
                },
                sortable: true,
                removable: true
            });

            if (this.values && this.values.length) {
                for (let value of this.values) {
                    $("#node-input-value-container").editableList('addItem', { value: value });
                }
            }
            if (this.weekdays && this.weekdays.length) {
                for (let weekday of this.weekdays) {
                    $("#node-input-weekday-container").editableList('addItem', { event: weekday });
                }
            }
            if (this.dates && this.dates.length) {
                for (let date of this.dates) {
                    $("#node-input-date-container").editableList('addItem', { event: date });
                }
            }
        },
        oneditsave: function () {
            let node = this;
            // store values from editable list
            let values = $("#node-input-value-container").editableList('items');
            node.values = [];
            values.each(function(i) {
                let container = $(this);
                let value = {
                    name: container.find(".node-input-value-name").val(),
                    value: container.find(".node-input-value-value").val()
                };
                node.values.push(value);
            });

            // store weekdays from editable list
            let weekdays = $("#node-input-weekday-container").editableList('items');
            node.weekdays = [];
            weekdays.each(function(i) {
                let container = $(this);
                let event = {
                    weekday: container.find(".node-input-weekday-weekday").val(),
                    value: container.find(".node-input-weekday-value option:selected").text(),
                    hour: container.find(".node-input-weekday-hour").val(),
                    minute: container.find(".node-input-weekday-minute").val()
                };
                node.weekdays.push(event);
            });

            // store dates from editable list
            let dates = $("#node-input-date-container").editableList('items');
            node.dates = [];
            dates.each(function(i) {
                let container = $(this);
                let event = {
                    date: container.find(".node-input-date-date").val(),
                    value: container.find(".node-input-date-value option:selected").text(),
                    hour: container.find(".node-input-date-hour").val(),
                    minute: container.find(".node-input-date-minute").val()
                };
                node.dates.push(event);
            });

        }
    });
})()
</script>

<script type="text/html" data-template-name="ur_schedule">
    <div class="form-row">
        <label for="node-input-group"><i class="fa fa-table"></i> <span data-i18n="ur_schedule.label.group"></span></label>
        <input type="text" id="node-input-group">
    </div>
    <div class="form-row">
        <label><i class="fa fa-object-group"></i> <span data-i18n="ur_schedule.label.size"></span></label>
        <input type="hidden" id="node-input-width">
        <input type="hidden" id="node-input-height">
        <button class="editor-button" id="node-input-size"></button>
    </div>
    <div class="form-row">
        <label for="node-input-holidays"><i class="fa fa-sun-o"></i> <span data-i18n="ur_schedule.label.holidays"></span></label>
        <input type="text" id="node-input-holidays">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="ur_schedule.label.name"></span></label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-topic"><i class="fa fa-tasks"></i> <span data-i18n="ur_schedule.label.topic"></span></label>
        <input type="text" id="node-input-topic">
    </div>
    <div class="form-row" style="margin-bottom:0px;">
        <label for="node-input-value-container"><i class="fa fa-list"></i> <span data-i18n="ur_schedule.label.values"></span></label>
    </div>
    <div class="form-row node-input-value-container-row">
        <ol id="node-input-value-container"></ol>
    </div>
    <div class="form-row" style="margin-bottom:0px;">
        <label for="node-input-weekday-container"><i class="fa fa-clock-o"></i> <span data-i18n="ur_schedule.label.weekdays"></span></label>
    </div>
    <div class="form-row node-input-weekday-container-row">
        <ol id="node-input-weekday-container"></ol>
    </div>
    <div class="form-row" style="margin-bottom:0px;">
        <label for="node-input-date-container"><i class="fa fa-clock-o"></i> <span data-i18n="ur_schedule.label.dates"></span></label>
    </div>
    <div class="form-row node-input-date-container-row">
        <ol id="node-input-date-container"></ol>
    </div>
</script>

<script type="text/html" data-help-name="ur_schedule">
  <p>Will display a non-editable text field on the user interface.</p>
  <p>Each received <code>msg.payload</code> will update the text based on the provided <b>Value Format</b>.</p>
  <p>The <b>Value Format</b> field can be used to change the displayed format and can contain valid HTML and
  <a href="https://scotch.io/tutorials/all-about-the-built-in-angularjs-filters" target="_blank">Angular filters</a>.</p>
  <p>For example: <code>{{value | uppercase}} &amp;deg;</code> will uppercase the payload text and add the degree symbol.</p>
  <p>The label can also be set by a message property by setting
  the field to the name of the property, for example <code>{{msg.topic}}</code>.</p>
  <p>The following icon fonts are also available: <a href="https://klarsys.github.io/angular-material-icons/" target="_blank">Material Design icon</a>
      <i>(e.g. 'check', 'close')</i> or a <a href="https://fontawesome.com/v4.7.0/icons/" target="_blank">Font Awesome icon</a>
      <i>(e.g. 'fa-fire')</i>, or a <a href="https://github.com/Paul-Reed/weather-icons-lite/blob/master/css_mappings.md">Weather icon</a>.
      You can use the full set of google material icons if you add 'mi-' to the icon name. e.g. 'mi-videogame_asset'.</p>
  <p>The widget also has a class of <code>nr-dashboard-widget-{the_widget_label_with_underscores}</code> which can be used for additional 
      styling if required. You may need to use the <i>!important</i> flag to override the theme.</p>
</script>