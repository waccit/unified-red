<script type="text/javascript">
    RED.nodes.registerType('ur_form', {
        category: 'unified-red',
        color: 'rgb(176, 223, 227)',
        defaults: {
            name: { value: '' },
            label: { value: '' },
            group: { type: 'ur_group', required: true },
            order: { value: 0 },
            width: { value: 12 },
            height: { value: 0 },
            options: {
                value: [{ topic: '', label: '', type: '', outtopic: '' }], validate: function (value) {
                    if (value.length) {
                        for (var i = 0; i < value.length; i++) {
                            if (!value[i].topic) {
                                return false;
                            }
                        }
                    }
                    else {
                        return false;
                    }
                    return true;
                }, required: true
            },
            formValue: { value: {} },
            payload: { value: '' },
            submit: { value: "submit" },
            cancel: { value: "cancel" }
        },
        inputs: 1,
        outputs: 1,
        icon: "ur_form.png",
        paletteLabel: 'form',
        label: function () { return this.name || this.label || 'form'; },
        labelStyle: function () { return this.name ? "node_label_italic" : ""; },
        oneditprepare: function () {
            if ($("#node-input-submit").val() === null) { $("#node-input-submit").val("submit"); }
            if ($("#node-input-cancel").val() === null) { $("#node-input-cancel").val("cancel"); }
            $("#node-input-size").elementSizer({
                width: "#node-input-width"
            });

            function generateOption(i, option) {
                var container = $('<li/>', { style: "margin:0; padding:5px 0px; border-bottom:1px solid #ccc;" });
                var row = $('<div/>').appendTo(container);
                var rowOptions = $('<div/>', { style: "padding-top:5px; padding-left:22px;" }).appendTo(container);
                var rowOutTopic = $('<div/>', { style: "padding-top:5px; padding-left:22px; display: none;" }).appendTo(container);

                $('<i style="cursor:move; margin-left:3px;" class="node-input-option-handle fa fa-bars"></i>').appendTo(row);

                var labelField = $('<input/>', { class: "node-input-option-label", type: "text", style: "margin-left:7px; width:20%;", placeholder: 'label', value: option.label }).appendTo(row);
                var topicClass = "node-input-option-topic"
                if (!option.topic) { topicClass = "node-input-option-topic input-error"; }
                var topicField = $('<input/>', { class: topicClass, type: "text", style: "margin-left:7px; width:38%;", placeholder: 'topic', value: option.topic }).appendTo(row);
                topicField.keyup(function () {
                    if ($(this).val() && $(this).hasClass('input-error')) {
                        $(this).removeClass('input-error')
                    }
                    else {
                        if (!$(this).val()) {
                            $(this).addClass('input-error')
                        }
                    }

                });
                
                var typeField = $('<select/>', { class: "node-input-option-type", type: "text", style: "margin-left:7px; width:16%" }).appendTo(row);

                var arr = [
                    { val: "text", text: 'Text' },
                    { val: "multiline", text: 'Multiline' },
                    { val: "number", text: 'Number' },
                    { val: "email", text: 'E-mail' },
                    { val: "password", text: 'Password' },
                    { val: "checkbox", text: 'Checkbox' },
                    { val: "switch", text: 'Switch' },
                    { val: "select", text: 'Select' },
                    { val: "date", text: 'Date' }
                ];

                //var sel = $('<select>').appendTo('body');
                $(arr).each(function () {
                    var isSelected = false;
                    if (option.type == this.val) {
                        isSelected = true;
                    }
                    typeField.append($("<option>").attr('value', this.val).text(this.text).prop('selected', isSelected));
                });

                let setOptions = function (optionType, labelElem, inputElem, row) {
                    let value = "";
                    let text = "Options";
                    let placeholder = "";
                    switch (optionType) {
                        case "multiline":
                            value = Object.entries(option.options).map(o => o[0] + ':' + o[1]).join(', ');
                            text = "Rows";
                            placeholder = "Options e.g. rows:3";
                            row.show();
                            break;
                        case "text":
                        case "number":
                            value = Object.entries(option.options).map(o => o[0] + ':' + o[1]).join(', ');
                            placeholder = "Options e.g. units:%, precision:1";
                            row.show();
                            break;
                        case "select": 
                            value = Object.entries(option.options).map(o => o[0] + ':' + o[1]).join(', ');
                            text = "Options";
                            placeholder = "Options e.g. label1:value1, label2:value2";
                            row.show();
                            break;
                        default:
                            row.hide();
                            break;
                    }
                    labelElem.text(text);
                    inputElem.attr("placeholder", placeholder);
                    inputElem.val(value);
                };

                var optionsLabel = $('<label>', { style: "width:60px;" }).appendTo(rowOptions);
                var optionsField = $('<input/>', { class: "node-input-option-options", type: "text", style: "width:87%;" }).appendTo(rowOptions);
                setOptions(option.type, optionsLabel, optionsField, rowOptions);

                var deletespan = $('<div/>', { style: "display:inline-block; width:8%;" }).appendTo(row);
                var deleteButton = $('<a/>', { href: "#", class: "editor-button", style: "font-size:1.3em; left:45%; position:relative;" }).appendTo(deletespan);
                $('<i/>', { class: "fa fa-trash-o" }).appendTo(deleteButton);

                var morespan = $('<div/>', { style: "display:inline-block; width:8%;" }).appendTo(row);
                var moreButton = $('<a/>', { href: "#", class: "editor-button", style: "font-size:1.3em; left:45%; position:relative;" }).appendTo(morespan);
                $('<i/>', { class: "fa fa-caret-down" }).appendTo(moreButton);

                option.outtopic ? rowOutTopic.show() : rowOutTopic.hide();
                $('<label>', { style: "width:60px;" }).text("Output").appendTo(rowOutTopic);
                var outtopicField = $('<input/>', { class: "node-input-option-outtopic", type: "text", style: "width:87%;", placeholder: 'Output topic', value: option.outtopic }).appendTo(rowOutTopic);

                typeField.change(function (e) {
                    option.options = "";
                    setOptions(e.target.value, optionsLabel, optionsField, rowOptions);
                });

                deleteButton.click(function () {
                    container.find(".node-input-option-topic").removeAttr('required')
                    container.css({ "background": "#fee" });
                    container.fadeOut(300, function () {
                        $(this).remove();
                    });
                });

                moreButton.click(function () {
                    rowOutTopic.show();
                });

                $("#node-input-option-container").append(container);
            }

            $("#node-input-add-option").click(function () {
                generateOption($("#node-input-option-container").children().length + 1, {});
                $("#node-input-option-container-div").scrollTop($("#node-input-option-container-div").get(0).scrollHeight);
            });

            for (var i = 0; i < this.options.length; i++) {
                var option = this.options[i];
                generateOption(i + 1, option);
            }

            $("#node-input-option-container").sortable({
                axis: "y",
                handle: ".node-input-option-handle",
                cursor: "move"
            });
        },
        oneditsave: function () {
            var options = $("#node-input-option-container").children();
            var node = this;
            node.options = [];
            node.formValue = {};
            options.each(function (i) {
                var option = $(this);
                var o = {
                    label: option.find(".node-input-option-label").val(),
                    topic: option.find(".node-input-option-topic").val(),
                    type: option.find(".node-input-option-type").val(),
                    options: option.find(".node-input-option-options").val(),
                    outtopic: option.find(".node-input-option-outtopic").val()
                };
                if (o.type === 'text' || o.type === 'number' || o.type === 'multiline' || o.type === 'select') {
                    o.options = o.options.trim().split(/\s*,\s*/g).reduce((a,b) => {
                        var v = b.split(/\s*[:=]\s*/);
                        a[v[0]] = v[1];
                        return a;
                    }, {});
                }
                node.formValue[o.topic] = o.type == "checkbox" || o.type == "switch" ? false : "";
                node.options.push(o);
            });
        }
    });
</script>
<script type="text/html" data-template-name="ur_form">

<style>
.switch {
    position: relative;
    display: inline-block;
    width: 30px;
    height: 18px;
}

.switch input {display:none;}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    -webkit-transition: .4s;
    transition: .4s;
}

.slider:before {
    position: absolute;
    content: "";
    height: 15px;
    width: 15px;
    left: 2px;
    bottom: 2px;
    background-color: white;
    -webkit-transition: .4s;
    transition: .4s;
}

input:checked + .slider {
    background-color: #910000;
}

input:focus + .slider {
    box-shadow: 0 0 1px #2196F3;
}

input:checked + .slider:before {
    -webkit-transform: translateX(11px);
    -ms-transform: translateX(11px);
    transform: translateX(11px);
}

/* Rounded sliders */
.slider.round {
    border-radius: 34px;
}

.slider.round:before {
    border-radius: 50%;
}
</style>

    <div class="form-row">
        <label for="node-input-group"><i class="fa fa-table"></i> Group</label>
        <input type="text" id="node-input-group">
    </div>
    <div class="form-row">
        <label><i class="fa fa-object-group"></i> Size</label>
        <input type="hidden" id="node-input-width">
        <input type="hidden" id="node-input-height">
        <button class="editor-button" id="node-input-size"></button>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name">
    </div>
    <div class="form-row">
        <label for="node-input-label"><i class="fa fa-tag"></i> Label</label>
        <input type="text" id="node-input-label" placeholder="optional label">
    </div>
    <div class="form-row node-input-option-container-row" style="margin-bottom:0px; width:100%; min-width:520px">
        <label style="vertical-align:top;"><i class="fa fa-list-alt"></i> Form elements</label>
        <div style="display:inline-block; width:78%; border:1px solid #ccc; border-radius:5px; box-sizing:border-box;">
          <div class="red-ui-tray-header" style="width:100%; display: inline-block; padding-top:10px; padding-buttom:10px; border-top:0px solid; border-radius:5px 5px 0 0; border-bottom:1px solid #ccc;">
              <div style="width:94%; display:inline-block; margin-left:27px">
                <div style="width:20%; text-align:center; float:left;">Label</div>
                <div style="width:38%; text-align:center; float:left; margin-left:9px">Topic</div>
                <div style="margin-left:7px; width:16%; text-align:center; float:left; margin-left:9px">Type</div>
            </div>
          </div>
          <div id="node-input-option-container-div" style=" height: 257px; padding: 5px; overflow-y:scroll;">
            <ol id="node-input-option-container" style=" list-style-type:none; margin: 0;"></ol>
          </div>
        </div>
    </div>
    <div class="form-row">
        <a href="#" class="editor-button editor-button-small" id="node-input-add-option" style="margin-top: 4px; margin-left: 103px;"><i class="fa fa-plus"></i> <span>element</span></a>
    </div>
    <div class="form-row">
        <label for="node-input-submit"><i class="fa fa-square"></i> Buttons</label>
        <i class="fa fa-thumbs-o-up"></i> <input type="text" id="node-input-submit" placeholder="submit button text" style="width:35%;">
        <span style="margin-left:16px"><i class="fa fa-thumbs-o-down"></i></span>
        <input type="text" id="node-input-cancel" placeholder="cancel button text" style="width:35%;">
    </div>
</script>

<script type="text/html" data-help-name="ur_form">
    <p>Adds a form to user interface.</p>
    <p>Helps to collect multiple value from the user on submit button click as an object in <code> msg.payload</code> </p>
    <p>Multiple input elements can be added using add elements button</p>
    <p>Each element contains following components:</p>
    <ul>
        <li> <b>Label</b> : Value that will be the label of the element in the user interface</li>
        <li> <b>Topic</b> : Represents the topic assocated with <code>msg.payload</code></li>
        <li> <b>Type</b> : Drop drown option to select the type of input element</li>
        <li> <b>Options</b> : for multiline, number of UI rows for multiline text input. for select, list of options label:value pairs.</li>
        <li> <b>Output Topic</b> : used to override the <code>msg.topic</code> property.</p>
        <li> <b>Delete</b> : To remove the current element form the form</li>
    </ul>
    <p>The Cancel button can be hidden by setting it's value to be blank "".</p>
</script>