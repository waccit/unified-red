<style>
    :root {
        --nr-db-dark-text: #444;
        --nr-db-light-text: #eee;
        --nr-db-disabled-text: #999;
    }

    .nr-db-sb {
        position: absolute;
        top: 1px;
        bottom: 2px;
        left: 1px;
        right: 1px;
        overflow-y: scroll;
        padding: 10px;
    }

    .nr-db-sb .form-row label {
        display: block;
        width: auto;
    }

    .nr-db-sb .form-row input,
    .nr-db-sb .form-row select {
        width: calc(100% - 100px);
        margin-bottom: 0;
    }

    .nr-db-sb .compact {
        margin-bottom: 8px !important;
    }

    .nr-db-sb .red-ui-editableList-container {
        padding: 0;
        min-height: 250px;
        height: auto;
    }

    .nr-db-sb-menu-item-list {
        min-height: 250px;
        height: auto;
    }

    .nr-db-sb-menu-item-list li {
        padding: 0;
    }

    .nr-db-sb-menu-item-list-item {
        border-radius: 4px;
        color: var(--nr-db-dark-text);
    }

    .nr-db-sb-list-header {
        cursor: pointer;
        position: relative;
        color: var(--nr-db-dark-text);
        padding: 3px;
        white-space: nowrap;
    }

    .nr-db-sb-list-header:hover {
        color: var(--nr-db-dark-text);
    }

    .nr-db-sb-title-hidden {
        text-decoration: line-through;
    }

    .nr-db-sb-title-disabled {
        color: var(--nr-db-disabled-text);
    }

    .nr-db-sb-menu-item-list-header {
        /* background: var(--nr-db-light-text); */
        padding: 5px;
    }

    /* .nr-db-sb-menu-page-list-header:hover,
    .nr-db-sb-group-list-header:hover,
    .nr-db-sb-widget-list-header:hover {
        background: var(--nr-db-light-text);
    } */

    .nr-db-sb-list-chevron {
        width: 15px;
        text-align: center;
        margin: 3px 5px 3px 5px;
    }

    .nr-db-sb-menu-item-list-item .red-ui-editableList-container {
        border-radius: 0;
        border: none;
        height: auto !important;
        min-height: unset;
        padding-left: 15px;
    }

    .red-ui-editableList-container li {
        border: none;
    }

    .nr-db-sb-list-handle {
        vertical-align: top;
        opacity: 0;
        cursor: move;
    }

    .nr-db-sb-list-header:hover > .nr-db-sb-list-handle,
    .nr-db-sb-list-header:hover > .nr-db-sb-list-header-button-group {
        opacity: 1;
    }

    .nr-db-sb-list-header-button-group {
        opacity: 0;
    }

    .nr-db-sb-list-handle {
        color: var(--nr-db-dark-text);
        padding: 5px;
    }

    .nr-db-sb-menu-item-list-header > .nr-db-sb-list-chevron {
        margin-left: 0px;
        transition: transform 0.2s ease-in-out;
    }

    .nr-db-sb-group-list-header > .nr-db-sb-list-chevron {
        margin-left: 20px;
        transition: transform 0.2s ease-in-out;
    }

    .nr-db-sb-group-list {
        min-height: 10px;
    }

    .nr-db-sb-group-list li {
        border-bottom-color: var(--nr-db-light-text);
    }

    .nr-db-sb-group-list > li.ui-sortable-helper {
        border-top: 1px solid var(--nr-db-light-text);
    }

    .nr-db-sb-group-list > li:last-child {
        border-bottom: none;
    }

    .nr-db-sb-widget-list > li {
        border: none !important;
    }

    .nr-db-sb-group-list > li > .red-ui-editableList-item-handle {
        left: 10px;
    }

    .nr-db-sb-list-button-group {
        position: absolute;
        right: 3px;
        top: 0px;
        z-index: 2;
    }

    .nr-db-sb-list-header-button-group {
        position: absolute;
        right: 3px;
        top: 4px;
    }

    .nr-db-sb-list-header-button {
        margin-left: 5px;
    }

    .nr-db-sb li.ui-sortable-helper {
        opacity: 0.9;
    }

    .nr-db-sb-widget-icon {
        margin-left: 56px;
    }

    .nr-db-sb-icon {
        margin-right: 10px;
    }

    .nr-db-sb-link {
        display: inline-block;
        padding-left: 20px;
    }

    .nr-db-sb-link-name-container .fa-external-link {
        margin-right: 10px;
    }

    .nr-db-sb-link-url {
        font-size: 0.8em;
        color: var(--nr-db-mid-grey);
    }

    span.nr-db-color-pick-container {
        max-width: 50px;
        border-radius: 3px;
        margin-left: 15px;
    }

    input.nr-db-field-themeColor[type='color'] {
        width: 60px !important;
        padding: 0px;
        height: 20px;
        box-shadow: none;
        position: absolute;
        right: 36px;
        border-radius: 3px !important;
        border: solid 1px #ccc;
        -webkit-appearance: none;
        font-size: smaller;
        text-align: center;
    }

    input.nr-db-field-themeColor::-webkit-color-swatch {
        border: none;
    }

    .red-ui-tabs {
        margin-bottom: 15px;
    }

    .red-ui-tab.hidden {
        display: none;
    }

    #dashboard-tabs-list li a:hover {
        cursor: pointer;
    }

    #dash-link-button {
        background: none;
        border: none;
        margin-top: 3px;
        display: inline-block;
        margin: 3px 0px 0px 3px;
        height: 32px;
        line-height: 29px;
        max-width: 200px;
        overflow: hidden;
        white-space: nowrap;
        position: relative;
        padding: 0px 7px 0px 7px;
    }

    ul.red-ui-dashboard-theme-styles {
        list-style: none;
    }

    ul.red-ui-dashboard-theme-styles li {
        margin-bottom: 6px;
    }

    .nr-db-resetIcon {
        margin: 3px 6px 0px 6px;
        float: right;
        color: var(--nr-db-mid-grey);
        opacity: 0.8;
        display: block;
    }

    .nr-db-resetIcon:hover {
        cursor: pointer;
    }

    #nr-db-field-font {
        margin-left: 2em;
        width: calc(100% - 81px);
    }

    .nr-db-theme-label {
        font-weight: bold;
    }

    #custom-theme-library-container .btn-group {
        margin-bottom: 10px;
    }
</style>

<!-- Dashboard layout tool -->
<link rel="stylesheet" href="./ur_base/css/gridstack.min.css" />
<link rel="stylesheet" href="./ur_base/css/gridstack-extra.min.css" />
<style>
    .grid-stack {
        background-color: #f8f8f8;
        border: solid 2px #c0c0c0;
        margin: auto;
        min-height: 46px;
        display: table-cell;
        background-image: linear-gradient(#c0c0c0 1px, transparent 0),
            linear-gradient(90deg, #c0c0c0 1px, transparent 0);
        background-size: 40px 47px;
    }

    .grid-stack > .grid-stack-item > .grid-stack-item-content {
        top: 3px;
        left: 5px;
        right: 5px;
        bottom: 3px;
    }

    .grid-stack-item-content {
        color: #2c3e50;
        text-align: center;
        background-color: #b0dfe3;
        border-radius: 2px;
        font-family: 'Helvetica Neue', Arial, Helvetica, sans-serif;
        white-space: nowrap;
        font-size: 12px;
        opacity: 0.7;
    }

    .grid-stack-item {
        cursor: move;
    }

    .nr-dashboard-layout-container-fluid {
        width: 100%;
        padding-right: 0px;
        padding-left: 0px;
        margin-right: 0px;
        margin-left: 0px;
    }

    .nr-dashboard-layout-row {
        width: 100%;
        display: -ms-flexbox;
        display: flex;
        -ms-flex-wrap: wrap;
        flex-wrap: wrap;
        margin-right: 0px;
        margin-left: 0px;
    }

    .nr-dashboard-layout-span12 {
        width: 98.4%;
        padding: 2px;
        margin-left: 2px;
    }

    .nr-dashboard-layout-span6 {
        width: 49.2%;
        padding: 2px;
        margin-left: 2px;
    }

    .nr-dashboard-layout-span4 {
        width: 32.7%;
        padding: 2px;
        margin-left: 2px;
    }

    .nr-dashboard-layout-span3 {
        width: 24.3%;
        padding: 2px;
        margin-left: 2px;
    }

    .nr-dashboard-layout-span2 {
        width: 16%;
        padding: 2px;
        margin-left: 2px;
    }

    .nr-dashboard-layout-resize-disable {
        cursor: pointer;
        float: right;
        position: relative;
        z-index: 90;
        margin-right: 4px;
    }

    .nr-dashboard-layout-resize-enable {
        cursor: pointer;
        float: right;
        position: relative;
        z-index: 90;
        margin-right: 1px;
    }

    .grid-stack > .ui-state-disabled {
        opacity: 1;
        background-image: none;
    }

    .grid-stack > .grid-stack-item > .ui-resizable-handle {
        z-index: 90;
        margin-right: -7px;
    }
</style>

<script type="text/javascript">
    (function ($) {
        var editSaveEventHandler;
        var nodesAddEventHandler;
        var nodesRemoveEventHandler;
        var layoutUpdateEventHandler; // Dashboard layout tool
        var uip = 'ui';

        // convert to i18 text
        function c_(x) {
            return RED._('unified-red/ur_base:ur_base.' + x);
        }

        var oldSpacer; // Spacer not needed after editing

        var widthChange; // Group width change
        var widgetMove; // Move widget event
        var widgetResize; // Change widget event
        var widgetDrag; // Drag widget event

        var MAX_GROUP_WIDTH = 12; // The maximum width is 12

        function getMenuPageDataFromNodes(menuItemId, menuPageId) {
            var nodes = RED.nodes.createCompleteNodeSet(false);
            // console.log('ur_base.html 408 nodes: ', nodes);

            var menuPage = {};

            // Menu Page Information
            for (let i = 0; i < nodes.length; i++) {
                if (nodes[i].type == 'ur_menu_page' && nodes[i].id == menuPageId) {
                    menuPage = {
                        menuItemId,
                        id: nodes[i].id,
                        type: nodes[i].type,
                        order: nodes[i].order,
                        width: nodes[i].width,
                        groups: [],
                    };
                    break;
                }
            }

            // Group Information
            nodes.forEach((node) => {
                if (node.type == 'ur_group' && node.menuPage == menuPageId) {
                    var group = {
                        id: node.id,
                        name: node.name,
                        type: node.type,
                        order: node.order,
                        // width: nodes[cnt].width,
                        widthLg: nodes[cnt].widthLg,
                        widthMd: nodes[cnt].widthMd,
                        widthSm: nodes[cnt].widthSm,
                        widgets: [],
                    };
                    menuPage.groups.push(group);
                }
            });

            // Widget Information
            var groupIdx = {};
            menuPage.groups.forEach((group) => {
                groupIdx[group.id] = group;
            });

            var isWidget = (nodeType) => {
                return (
                    nodeType !== 'ur_link' &&
                    nodeType !== 'ur_toast' &&
                    nodeType !== 'ur_ui_control' &&
                    nodeType !== 'ur_audio' &&
                    nodeType !== 'ur_base' &&
                    nodeType !== 'ur_group' &&
                    nodeType !== 'ur_menu_page' &&
                    nodeType !== 'ur_menu_item'
                );
            };

            nodes.forEach((node) => {
                var group = groupIdx[node.group];
                if (group && /^ur_/.test(node.type) && isWidget(node.type)) {
                    var widget = {
                        id: node.id,
                        type: node.type,
                        order: node.order,
                        width: node.width,
                        // height: node.height,
                        // auto: node.width == 0 ? true : false,
                    };
                    group.widgets.push(widget);

                    // if (!isLayoutToolSupported(node.type)) {
                    //     console.log('LayoutTool warning: Unsupported widget. Widget=' + JSON.stringify(widget));
                    // }
                }
            });
            return menuPage;
        }

        ////////////////////////////////////////
        // Sort by order
        ////////////////////////////////////////
        function compareOrder(a, b) {
            var r = 0;
            if (a.order < b.order) {
                r = -1;
            } else if (a.order > b.order) {
                r = 1;
            }

            return r;
        }

        ////////////////////////////////////////
        // Sort by XY
        ////////////////////////////////////////
        function compareXY(a, b) {
            var r = 0;
            if (a.y < b.y) {
                r = -1;
            } else if (a.y > b.y) {
                r = 1;
            } else if (a.x < b.x) {
                r = -1;
            } else if (a.x > b.x) {
                r = 1;
            }
            return r;
        }

        ///////////////////////////////////////////////////////
        // Placeable location search (placed in the upper left)
        ///////////////////////////////////////////////////////
        function search_point(width, height, maxWidth, maxHeight, tbl) {
            for (var y = 0; y < maxHeight; y++) {
                for (var x = 0; x < maxWidth; x++) {
                    if (check_matrix(x, y, width, height, maxWidth, tbl)) {
                        fill_matrix(x, y, width, height, maxWidth, tbl);
                        return { x: x, y: y };
                    }
                }
            }
            return false;
        }
        // Check placement position
        function check_matrix(px, py, width, height, maxWidth, tbl) {
            if (px + width > maxWidth) return false;
            for (var y = py; y < py + height; y++) {
                for (var x = px; x < px + width; x++) {
                    if (tbl[maxWidth * y + x]) return false;
                }
            }
            return true;
        }
        // Mark the placement position
        function fill_matrix(px, py, width, height, maxWidth, tbl) {
            for (var y = py; y < py + height; y++) {
                for (var x = px; x < px + width; x++) {
                    tbl[maxWidth * y + x] = 1;
                }
            }
        }

        ////////////////////////////////////////////////////
        // Register Base Node
        ////////////////////////////////////////////////////
        RED.nodes.registerType('ur_base', {
            category: 'config',
            defaults: {
                name: {},
                theme: {},
                site: {},
            },
            hasUsers: false,
            paletteLabel: 'Dashboard',
            label: function () {
                return this.name || 'Unified-RED Dashboard';
            },
            labelStyle: function () {
                return this.name ? 'node_label_italic' : '';
            },
            onpaletteremove: function () {
                RED.sidebar.removeTab('dashboard');
                RED.events.off('editor:save', editSaveEventHandler);
                RED.events.off('nodes:add', nodesAddEventHandler);
                RED.events.off('nodes:remove', nodesRemoveEventHandler);
                RED.events.off('layout:update', layoutUpdateEventHandler); // Dashboard layout tool
            },
            onpaletteadd: function () {
                var globalDashboardNode = null;
                var editor;

                function ensureDashboardNode(createMissing) {
                    if (globalDashboardNode !== null) {
                        // Check if it has been deleted beneath us
                        var n = RED.nodes.node(globalDashboardNode.id);
                        if (n === null) {
                            globalDashboardNode = null;
                        }
                    }

                    // Find the old dashboard node
                    if (globalDashboardNode === null) {
                        var bases = [];
                        RED.nodes.eachConfig(function (n) {
                            if (n.type === 'ur_base') {
                                bases.push(n);
                            }
                        });

                        // make sure we only have one ur_base node
                        // at the moment this will just use our existing one - deleting any new base node and theme
                        // at some point we may want to make this an option to select one or the other.
                        while (bases.length > 1) {
                            var n = bases.pop();
                            RED.nodes.remove(n.id);
                            RED.nodes.dirty(true);
                        }

                        if (bases.length === 1) {
                            globalDashboardNode = bases[0];
                        }

                        // If there is no dashboard node, ensure we create it after
                        // initializing
                        var noDashboardNode = globalDashboardNode === null;

                        // set up theme state
                        // TODO: Remove these stuffs
                        // var themeState = {};
                        // var baseColor = '#0094CE';
                        // for (var i = 0; i < baseStyles.length; i++) {
                        //     themeState[baseStyles[i]] = { default: baseColor, value: baseColor, edited: false };
                        // }
                        // for (var j = 0; j < configurableStyles.length; j++) {
                        //     var underscore = configurableStyles[j].split('-').join('_');
                        //     var colour = colours['calculate_' + underscore](baseColor);
                        //     themeState[configurableStyles[j]] = { value: colour, edited: false };
                        // }
                        // themeState['base-font'] = { value: baseFontName };

                        // var missingFields =
                        //     !globalDashboardNode ||
                        //     !globalDashboardNode.theme ||
                        //     !globalDashboardNode.site ||
                        //     !globalDashboardNode.site.sizes;

                        // if (missingFields && createMissing) {
                        //     var lightTheme = {
                        //         default: baseColor,
                        //         baseColor: baseColor,
                        //         baseFont: baseFontName,
                        //         edited: false,
                        //     };
                        //     var darkTheme = {
                        //         default: '#097479',
                        //         baseColor: '#097479',
                        //         baseFont: baseFontName,
                        //         edited: false,
                        //     };
                        //     var customTheme = {
                        //         name: 'Untitled Theme 1',
                        //         default: '#4B7930',
                        //         baseColor: '#4B7930',
                        //         baseFont: baseFontName,
                        //     };
                        //     var oldThemeName;
                        //     if (globalDashboardNode && typeof (globalDashboardNode.theme === 'string')) {
                        //         oldThemeName = globalDashboardNode.theme;
                        //     }

                        //     var theme = {
                        //         name: oldThemeName || 'theme-light',
                        //         lightTheme: lightTheme,
                        //         darkTheme: darkTheme,
                        //         customTheme: customTheme,
                        //         themeState: themeState,
                        //         angularTheme: aTheme,
                        //     };

                        //     var site_name = c_('site.title');
                        //     var site_date_format = c_('site.date-format');
                        //     var site = {
                        //         name: site_name,
                        //         hideToolbar: 'false',
                        //         allowSwipe: 'false',
                        //         lockMenu: 'false',
                        //         allowTempTheme: 'true',
                        //         dateFormat: site_date_format,
                        //         sizes: sizes,
                        //     };
                        //     if (globalDashboardNode !== null) {
                        //         if (typeof globalDashboardNode.site !== 'undefined') {
                        //             site = {
                        //                 name: globalDashboardNode.site.name || globalDashboardNode.name,
                        //                 hideToolbar: globalDashboardNode.site.hideToolbar,
                        //                 lockMenu: globalDashboardNode.site.lockMenu,
                        //                 allowSwipe: globalDashboardNode.site.allowSwipe,
                        //                 allowTempTheme: globalDashboardNode.site.allowTempTheme,
                        //                 dateFormat: globalDashboardNode.site.dateFormat,
                        //                 sizes: globalDashboardNode.site.sizes,
                        //             };
                        //         }
                        //         if (globalDashboardNode.theme.hasOwnProperty('angularTheme')) {
                        //             aTheme = globalDashboardNode.theme.angularTheme;
                        //         } else {
                        //             globalDashboardNode.theme.angularTheme = aTheme;
                        //         }
                        //     }

                        //     if (noDashboardNode) {
                        //         globalDashboardNode = {
                        //             id: RED.nodes.id(),
                        //             _def: RED.nodes.getType('ur_base'),
                        //             type: 'ur_base',
                        //             site: site,
                        //             theme: theme,
                        //             users: [],
                        //         };
                        //         RED.nodes.add(globalDashboardNode);
                        //     } else {
                        //         globalDashboardNode['_def'] = RED.nodes.getType('ur_base');
                        //         globalDashboardNode.site = site;
                        //         globalDashboardNode.theme = theme;
                        //         delete globalDashboardNode.name;
                        //     }
                        //     $('#nr-db-field-font').val(baseFontName);
                        //     RED.nodes.dirty(true);
                        // }
                    }
                }

                var content = $('<div>').css({ 'position': 'relative', 'height': '100%' });
                var mainContent = $('<div>', { class: 'nr-db-sb' }).appendTo(content);
                var form = $('<form class="dialog-form">').appendTo(mainContent);

                // Dashboard Tabs markup
                var divTab = $('<div class="red-ui-tabs">').appendTo(form);
                var ulDashboardTabs = $('<ul id="dashboard-tabs-list"></ul>').appendTo(divTab);
                var layout_label = c_('label.layout');
                var site_label = c_('label.site');
                // var theme_label = c_('label.theme');
                // var angular_label = c_('label.angular');
                var liLayoutTab = $(
                    '<li class="red-ui-tab" style="width:70px;"><a class="red-ui-tab-label" title="Layout"><span>' +
                        layout_label +
                        '</span></a></li>'
                ).appendTo(ulDashboardTabs);
                var liSiteTab = $(
                    '<li class="red-ui-tab" style="width:70px;"><a class="red-ui-tab-label" title="Site" style="width:60px;"><span>' +
                        site_label +
                        '</span></a></li>'
                ).appendTo(ulDashboardTabs);
                // var liThemeTab = $(
                //     '<li class="red-ui-tab" style="width:70px;"><a class="red-ui-tab-label" title="Theme" style="width:80px;"><span>' +
                //         theme_label +
                //         '</span></a></li>'
                // ).appendTo(ulDashboardTabs);
                // var liAngularTab = $(
                //     '<li class="red-ui-tab" style="width:70px;"><a class="red-ui-tab-label" title="Angular" style="width:80px;"><span>' +
                //         angular_label +
                //         '</span></a></li>'
                // ).appendTo(ulDashboardTabs);

                // Link out to dashboard
                $.getJSON('uisettings', function (data) {
                    if (data.hasOwnProperty('path')) {
                        uip = data.path;
                    }
                    var lnk = document.location.host + RED.settings.httpNodeRoot + '/' + uip;
                    var re = new RegExp('\/{1,}', 'g');
                    lnk = lnk.replace(re, '/');
                    if (!RED.hasOwnProperty('actions')) {
                        RED.keyboard.add('*', /* d */ 68, { ctrl: true, shift: true }, function () {
                            window.open(document.location.protocol + '//' + lnk, 'nr-dashboard');
                        });
                    } else {
                        RED.keyboard.add('*', 'ctrl-shift-d', 'dashboard:show-dashboard');
                        RED.actions.add('dashboard:show-dashboard', function () {
                            window.open(document.location.protocol + '//' + lnk, 'nr-dashboard');
                        });
                    }
                    $(
                        '<span id="dash-link-button" class="editor-button" style="position:absolute; right:0px;"><i class="fa fa-external-link"></i></span>'
                    )
                        .click(function (evt) {
                            window.open(document.location.protocol + '//' + lnk);
                            evt.preventDefault();
                        })
                        .appendTo(ulDashboardTabs);
                });

                // Dashboard Tab containers
                var layoutTab = $('<div id="dashboard-layout" style="height:calc(100% - 48px)">').appendTo(form);
                var siteTab = $('<div id="dashboard-site" style="display:none;">').appendTo(form);
                // var themeTab = $('<div id="dashboard-theme" style="display:none;">').appendTo(form);
                // var angularTab = $('<div id="dashboard-angular" style="display:none;">').appendTo(form);

                ulDashboardTabs.children().first().addClass('active');

                // Tab logic
                var onTabClick = function () {
                    //Toggle tabs
                    ulDashboardTabs.children().removeClass('active');
                    ulDashboardTabs.children().css({ 'transition': 'width 100ms' });
                    $(this).parent().addClass('active');

                    var selectedTab = $(this)[0].title;
                    if (selectedTab === 'Layout') {
                        // themeTab.hide();
                        siteTab.hide();
                        // angularTab.hide();
                        layoutTab.show();
                    } /* else if (selectedTab === 'Angular') {
                        themeTab.hide();
                        siteTab.hide();
                        angularTab.show();
                        layoutTab.hide();
                    } else if (selectedTab === 'Theme') {
                        layoutTab.hide();
                        siteTab.hide();
                        angularTab.hide();
                        themeTab.show();
                        if ($('#nr-db-field-theme option:selected').val() === 'theme-custom') {
                            themeSettingsContainer.show();
                        } else {
                            themeSettingsContainer.hide();
                        }
                    } */ else {
                        layoutTab.hide();
                        // themeTab.hide();
                        // angularTab.hide();
                        siteTab.show();
                    }
                };

                ulDashboardTabs.find('li.red-ui-tab a').on('click', onTabClick);

                // Site Tab
                var divTitle = $('<div>', { class: 'form-row compact' }).appendTo(siteTab);
                $('<div>')
                    .html('<b>' + c_('label.title') + '</b>')
                    .appendTo(divTitle);
                $('<input type="text" id="nr-db-field-title">')
                    .val(site_name)
                    .css('width', '100%')
                    .on('change', function () {
                        if (!globalDashboardNode || globalDashboardNode.site.name !== $(this).val()) {
                            ensureDashboardNode(true);
                            globalDashboardNode.site.name = $(this).val();
                            RED.nodes.dirty(true);
                        }
                    })
                    .appendTo(divTitle);

                var divHideToolbar = $('<div>', { class: 'form-row compact' }).appendTo(siteTab);
                $('<div>')
                    .html('<b>' + c_('label.options') + '</b>')
                    .appendTo(divHideToolbar);
                $('<select id="nr-db-field-hideToolbar">')
                    .css('width', '100%')
                    .append($('<option>', { value: 'false', text: c_('title-bar.show'), selected: true }))
                    .append($('<option>', { value: 'true', text: c_('title-bar.hide') }))
                    .val('false')
                    .on('change', function () {
                        if (!globalDashboardNode || globalDashboardNode.site.hideToolbar !== $(this).val()) {
                            ensureDashboardNode(true);
                            globalDashboardNode.site.hideToolbar = $(this).val();
                            RED.nodes.dirty(true);
                        }
                    })
                    .appendTo(divHideToolbar);

                var divLockMenu = $('<div>', { class: 'form-row compact' }).appendTo(siteTab);
                $('<select id="nr-db-field-lockMenu">')
                    .css('width', '100%')
                    .append($('<option>', { value: 'false', text: c_('lock.clicked'), selected: true }))
                    .append($('<option>', { value: 'true', text: c_('lock.locked') }))
                    .val('false')
                    .on('change', function () {
                        if (!globalDashboardNode || globalDashboardNode.site.lockMenu !== $(this).val()) {
                            ensureDashboardNode(true);
                            globalDashboardNode.site.lockMenu = $(this).val();
                            RED.nodes.dirty(true);
                        }
                    })
                    .appendTo(divLockMenu);

                var site_name = c_('site.title');

                //Layout Tab
                var divTabs = $('<div>', { class: 'form-row', style: 'position:relative' }).appendTo(layoutTab);
                $('<label>')
                    .html('<b>' + c_('layout.nav-menu') + '</b>')
                    .appendTo(divTabs);

                var buttonGroup = $('<div>', { class: 'nr-db-sb-list-button-group' }).appendTo(divTabs);

                //Toggle expand buttons
                $(
                    '<a href="#" class="editor-button editor-button-small nr-db-sb-list-header-button"><i class="fa fa-angle-double-up"></i></a>'
                )
                    .click(function (evt) {
                        menuItemContainer
                            .find('.nr-db-sb-widget-list-container')
                            .slideUp()
                            .addClass('nr-db-sb-collapsed');
                        menuItemContainer
                            .find('.nr-db-sb-group-list-container')
                            .slideUp()
                            .addClass('nr-db-sb-collapsed');
                        menuItemContainer
                            .find('.nr-db-sb-menu-page-list-container')
                            .slideUp()
                            .addClass('nr-db-sb-collapsed');
                        menuItemContainer
                            .find('.nr-db-sb-menu-item-container-list-container')
                            .slideUp()
                            .addClass('nr-db-sb-collapsed');

                        menuItemContainer
                            .find('.nr-db-sb-menu-item-container-list-header>.nr-db-sb-list-chevron')
                            .css({ 'transform': 'rotate(-90deg)' });
                        menuItemContainer
                            .find('.nr-db-sb-menu-item-list-header>.nr-db-sb-list-chevron')
                            .css({ 'transform': 'rotate(-90deg)' });
                        menuItemContainer
                            .find('.nr-db-sb-menu-page-list-header>.nr-db-sb-list-chevron')
                            .css({ 'transform': 'rotate(-90deg)' });
                        menuItemContainer
                            .find('.nr-db-sb-group-list-header>.nr-db-sb-list-chevron')
                            .css({ 'transform': 'rotate(-90deg)' });

                        evt.preventDefault();
                    })
                    .appendTo(buttonGroup);
                $(
                    '<a href="#" class="editor-button editor-button-small nr-db-sb-list-header-button"><i class="fa fa-angle-double-down"></i></a>'
                )
                    .click(function (evt) {
                        menuItemContainer
                            .find('.nr-db-sb-widget-list-container')
                            .slideDown()
                            .removeClass('nr-db-sb-collapsed');
                        menuItemContainer
                            .find('.nr-db-sb-group-list-container')
                            .slideDown()
                            .removeClass('nr-db-sb-collapsed');
                        menuItemContainer
                            .find('.nr-db-sb-menu-page-list-container')
                            .slideDown()
                            .removeClass('nr-db-sb-collapsed');
                        menuItemContainer
                            .find('.nr-db-sb-menu-item-list-header>.nr-db-sb-list-chevron')
                            .css({ 'transform': '' });
                        menuItemContainer
                            .find('.nr-db-sb-menu-page-list-header>.nr-db-sb-list-chevron')
                            .css({ 'transform': '' });
                        menuItemContainer
                            .find('.nr-db-sb-group-list-header>.nr-db-sb-list-chevron')
                            .css({ 'transform': '' });
                        evt.preventDefault();
                    })
                    .appendTo(buttonGroup);

                // Add Item button
                $(
                    '<a href="#" class="editor-button editor-button-small nr-db-sb-list-header-button"><i class="fa fa-plus"></i> ' +
                        c_('layout.menuItem') +
                        '</a>'
                )
                    .click(function (evt) {
                        menuItemContainer.editableList('addItem', { type: 'ur_menu_item', child: false });
                        evt.preventDefault();
                    })
                    .appendTo(buttonGroup);

                // Add Link button
                $(
                    '<a href="#" class="editor-button editor-button-small nr-db-sb-list-header-button"><i class="fa fa-plus"></i> ' +
                        c_('layout.link') +
                        '</a>'
                )
                    .click(function (evt) {
                        menuItemContainer.editableList('addItem', { type: 'ur_link' });
                        evt.preventDefault();
                    })
                    .appendTo(buttonGroup);

                var menuItemLists = {};
                var menuPageLists = {};
                var groupLists = {};

                // toggle slide menu item content
                var titleToggle = function (id, content, chevron) {
                    return function (evt) {
                        if (content.is(':visible')) {
                            content.slideUp();
                            chevron.css({ 'transform': 'rotate(-90deg)' });
                            content.addClass('nr-db-sb-collapsed');
                            listStates[id] = false;
                        } else {
                            content.slideDown();
                            chevron.css({ 'transform': '' });
                            content.removeClass('nr-db-sb-collapsed');
                            listStates[id] = true;
                        }
                    };
                };

                /**
                 * Provides the default setups for Menu Item, Menu Page, or Menu Link
                 */
                var defaultMenuEntities = {
                    'ur_menu_item': {
                        type: 'ur_menu_item',
                        users: [],
                        icon: 'dashboard',
                        name: 'Item',
                    },
                    'ur_menu_page': {
                        type: 'ur_menu_page',
                        users: [],
                        icon: 'folder',
                        name: 'Page',
                        width: 6,
                        disp: true,
                    },
                    'ur_group': {
                        type: 'ur_group',
                        users: [],
                        name: 'Group',
                        widthLg: 6,
                        widthMd: 6,
                        widthSm: 12,
                        disp: true,
                    },
                    'ur_menu_link': {
                        type: 'ur_menu_link',
                        users: [],
                        icon: 'open_in_browser',
                        name: 'Link',
                        target: 'newtab',
                    },
                };

                /**
                 * Helper function for checking if node needs to be created.
                 * @return {Object} node
                 */
                var makeNode = function (container, i, item) {
                    // console.log('makeNode container: ', container);
                    // console.log('makeNode i: ', i);
                    // console.log('makeNode item: ', item);
                    // console.log('makeNode getType: ', RED.nodes.getType('ur_menu_page'));
                    if (!item.node) {
                        item.node = { ...defaultMenuEntities[item.type] };
                        item.node._def = RED.nodes.getType(item.type);
                        item.node.id = RED.nodes.id();
                        item.node.order = i + 1;
                        item.node.name += ' ' + item.node.order;

                        if (item.menuItem) {
                            item.node.menuItem = item.menuItem;
                        }

                        if (item.menuPage) {
                            item.node.menuPage = item.menuPage;
                        }
                    } else if (item.type === undefined) {
                        item.type = item.node.type;
                    }

                    listElements[item.node.id] = container;
                    RED.nodes.add(item.node);
                    // RED.history.push({
                    //     t: 'add',
                    //     nodes: [item.node.id],
                    //     dirty: RED.nodes.dirty(),
                    // });
                    // RED.nodes.dirty(true);

                    // if (RED.nodes.hasOwnProperty('updateConfigNodeUsers')) {
                    //     RED.nodes.updateConfigNodeUsers(item.node);
                    // }

                    return item;
                };

                /**
                 * Add a new Menu Item, Menu Page, Group, Menu Entity
                 *
                 * @param {string} container - the jQuery DOM element to which any row content should be added
                 * @param {Number} i - the index of the row
                 * @param {Object} item - the data object for the row. MUST include 'type' property
                 */
                var addMenuItem = function (container, i, item) {
                    let titleClass = 'nr-db-sb-list-header nr-db-sb-menu-item-list-header';
                    let containerClass = 'nr-db-sb-menu-item-list-item';

                    if (!item.node.menuItem && item.menuItem) {
                        item.node.menuItem = item.menuItem;
                    }

                    if (item.child) {
                        // item.node.menuItem = item.menuItem;
                        elementParents[item.node.id] = item.node.menuItem;
                        titleClass = 'nr-db-sb-list-header nr-db-sb-menu-item-content-list-header';
                        containerClass = 'nr-db-sb-menu-item-content-list-item';
                    }

                    item.children = item.children || [];
                    RED.history.push({
                        t: 'add',
                        nodes: [item.node.id],
                        dirty: RED.nodes.dirty(),
                    });
                    RED.nodes.dirty(true);

                    if (RED.nodes.hasOwnProperty('updateConfigNodeUsers')) {
                        RED.nodes.updateConfigNodeUsers(item.node);
                    }
                    // title
                    let titleRow = $('<div>', {
                        class: titleClass,
                    }).appendTo(container);

                    container.addClass(containerClass);

                    // add handle
                    $('<i class="nr-db-sb-list-handle nr-db-sb-menu-item-list-handle fa fa-bars"></i>').appendTo(
                        titleRow
                    );

                    // make chevron
                    let chevron = $('<i class="fa fa-angle-down nr-db-sb-list-chevron">', {
                        style: 'width:10px;',
                    }).appendTo(titleRow);

                    // make & add icon
                    let icon = 'fa-object-group';
                    $('<i>', { class: 'nr-db-sb-icon nr-db-sb-menu-item-icon fa ' + icon }).appendTo(titleRow);

                    // add hide & disable
                    let hide = item.node.hidden ? ' nr-db-sb-title-hidden' : '';
                    let able = item.node.disabled ? ' nr-db-sb-title-disabled' : '';
                    $('<span>', { class: 'nr-db-sb-title' + hide + able })
                        .text(item.node.name || '')
                        .appendTo(titleRow);

                    // buttons
                    let buttonGroup = $('<div>', { class: 'nr-db-sb-list-header-button-group' }).appendTo(titleRow);

                    // menu-item button
                    var addMenuItemButton = $(
                        '<a href="#" class="editor-button editor-button-small nr-db-sb-list-header-button"><i class="fa fa-plus"></i> ' +
                            c_('layout.menuItem') +
                            '</a>'
                    ).appendTo(buttonGroup);

                    // menu-page button
                    var addMenuPageButton = $(
                        '<a href="#" class="editor-button editor-button-small nr-db-sb-list-header-button"><i class="fa fa-plus"></i> ' +
                            c_('layout.menuPage') +
                            '</a>'
                    ).appendTo(buttonGroup);

                    // edit button
                    let editButton = $(
                        '<a href="#" class="editor-button editor-button-small nr-db-sb-list-header-button"><i class="fa fa-pencil"></i> ' +
                            c_('layout.edit') +
                            '</a>'
                    ).appendTo(buttonGroup);

                    editButton.on('click', function (evt) {
                        RED.editor.editConfig('', item.type, item.node.id);
                        evt.stopPropagation();
                        evt.preventDefault();
                    });

                    let content = $('<div>', { class: 'nr-db-sb-menu-item-content-container' }).appendTo(container);

                    if (listStates.hasOwnProperty(item.node.id) && !listStates[item.node.id]) {
                        content.hide();
                        chevron.css({ 'transform': 'rotate(-90deg)' });
                        content.addClass('nr-db-sb-collapsed');
                        listStates[item.node.id] = false;
                    } else {
                        listStates[item.node.id] = true;
                    }

                    titleRow.click(titleToggle(item.node.id, content, chevron));

                    // menu-item-content hook
                    let menuItemContentContainer = $('<ol>', { class: 'nr-db-sb-menu-item-content-list' })
                        .appendTo(content)
                        .editableList({
                            sortable: '.nr-db-sb-menu-item-content-list-header',
                            addButton: false,
                            height: 'auto',
                            connectWith: '.nr-db-sb-menu-item-content-list',
                            addItem: addMenuEntity,
                            sortItems: function (items) {
                                var historyEvents = [];
                                items.each(function (i, el) {
                                    var menuPageData = el.data('data');
                                    var node = menuPageData.node;
                                    var hev = {
                                        t: 'edit',
                                        node: node,
                                        changes: {
                                            order: node.order,
                                            menuItem: node.menuItem,
                                        },
                                        dirty: node.dirty,
                                        changed: node.changed,
                                    };
                                    historyEvents.push(hev);
                                    var changed = false;
                                    if (node.order !== i + 1) {
                                        node.order = i + 1;
                                        changed = true;
                                    }
                                    if (changed) {
                                        node.dirty = true;
                                        node.changed = true;
                                    }
                                    if (node.menuItem !== item.node.id) {
                                        var oldMenuItemNode = RED.nodes.node(node.menuItem);
                                        if (oldMenuItemNode) {
                                            var index = oldMenuItemNode.users.indexOf(node);
                                            oldMenuItemNode.users.splice(index, 1);
                                        }
                                        node.menuItem = item.node.id;
                                        item.node.users.push(node);
                                        changed = true;
                                    }
                                });
                                RED.history.push({
                                    t: 'multi',
                                    events: historyEvents,
                                });
                                RED.nodes.dirty(true);
                                RED.view.redraw();
                            },
                        });

                    menuItemLists[item.node.id] = menuItemContentContainer;

                    addMenuItemButton.click(function (evt) {
                        menuItemContentContainer.editableList('addItem', {
                            type: 'ur_menu_item',
                            child: true,
                            menuItem: item.node.id,
                        });
                        evt.stopPropagation();
                        evt.preventDefault();
                    });

                    addMenuPageButton.click(function (evt) {
                        menuItemContentContainer.editableList('addItem', {
                            type: 'ur_menu_page',
                            menuItem: item.node.id,
                        });
                        evt.stopPropagation();
                        evt.preventDefault();
                    });

                    item.children.forEach(function (child) {
                        child.child = true;
                        menuItemContentContainer.editableList('addItem', child);
                    });
                };

                var addMenuPage = function (container, i, item) {
                    if (!item.node.menuItem && item.menuItem) {
                        item.node.menuItem = item.menuItem;
                    }

                    item.groups = item.groups || [];

                    RED.history.push({
                        t: 'add',
                        nodes: [item.node.id],
                        dirty: RED.nodes.dirty(),
                    });
                    RED.nodes.dirty(true);

                    if (RED.nodes.hasOwnProperty('updateConfigNodeUsers')) {
                        RED.nodes.updateConfigNodeUsers(item.node);
                    }

                    let menuPageNode = item.node;
                    elementParents[menuPageNode.id] = item.node.menuItem;

                    container.addClass('nr-db-sb-menu-page-list-item');

                    // title row
                    let titleRow = $('<div>', {
                        class: 'nr-db-sb-list-header nr-db-sb-menu-item-content-list-header',
                    }).appendTo(container);

                    // handle
                    $('<i class="nr-db-sb-list-handle nr-db-sb-menu-page-list-handle fa fa-bars"></i>').appendTo(
                        titleRow
                    );

                    // chevron
                    let chevron = $('<i class="fa fa-angle-down nr-db-sb-list-chevron">', {
                        style: 'width:10px;',
                    }).appendTo(titleRow);

                    // icon
                    $('<i class="nr-db-sb-icon nr-db-sb-menu-page-icon fa fa-folder-o"></i>').appendTo(titleRow);

                    // title
                    let title = $('<span class="nr-db-sb-title">')
                        .text(menuPageNode.name || menuPageNode.id || '')
                        .appendTo(titleRow);

                    // button group
                    let buttonGroup = $('<div>', { class: 'nr-db-sb-list-header-button-group' }).appendTo(titleRow);
                    let addGroupButton = $(
                        '<a href="#" class="editor-button editor-button-small nr-db-sb-list-header-button"><i class="fa fa-plus"></i> ' +
                            c_('layout.group') +
                            '</a>'
                    ).appendTo(buttonGroup);
                    var editButton = $(
                        '<a href="#" class="editor-button editor-button-small nr-db-sb-list-header-button"><i class="fa fa-pencil"></i> ' +
                            c_('layout.edit') +
                            '</a>'
                    ).appendTo(buttonGroup);

                    let content = $('<div>', { class: 'nr-db-sb-group-list-container' }).appendTo(container);

                    if (!listStates.hasOwnProperty(menuPageNode.id) || !listStates[menuPageNode.id]) {
                        content.hide();
                        chevron.css({ 'transform': 'rotate(-90deg)' });
                        content.addClass('nr-db-sb-collapsed');
                        listStates[menuPageNode.id] = false;
                    } else {
                        listStates[menuPageNode.id] = true;
                    }

                    var groupContainer = $('<ol>', { class: 'nr-db-sb-group-list' })
                        .appendTo(content)
                        .editableList({
                            sortable: '.nr-db-sb-group-list-header',
                            addButton: false,
                            height: 'auto',
                            connectWith: '.nr-db-sb-group-list',
                            addItem: addMenuEntity,
                            sortItems: function (items) {
                                var historyEvents = [];
                                items.each(function (i, el) {
                                    var groupData = el.data('data');
                                    var node = groupData.node;
                                    var hev = {
                                        t: 'edit',
                                        node: node,
                                        changes: {
                                            order: node.order,
                                            menuPage: node.menuPage,
                                        },
                                        dirty: node.dirty,
                                        changed: node.changed,
                                    };
                                    historyEvents.push(hev);
                                    var changed = false;
                                    if (node.order !== i + 1) {
                                        node.order = i + 1;
                                        changed = true;
                                    }
                                    if (changed) {
                                        node.dirty = true;
                                        node.changed = true;
                                    }
                                    if (node.menuPage !== item.node.id) {
                                        var oldMenuPageNode = RED.nodes.node(node.menuPage);
                                        if (oldMenuPageNode) {
                                            var index = oldMenuPageNode.users.indexOf(node);
                                            oldMenuPageNode.users.splice(index, 1);
                                        }
                                        node.menuPage = item.node.id;
                                        item.node.users.push(node);
                                        changed = true;
                                    }
                                });
                                RED.history.push({
                                    t: 'multi',
                                    events: historyEvents,
                                });
                                RED.nodes.dirty(true);
                                RED.view.redraw();
                            },
                        });

                    if (menuPageNode.id) {
                        menuPageLists[menuPageNode.id] = groupContainer;
                    }

                    titleRow.click(titleToggle(menuPageNode.id, content, chevron));

                    addGroupButton.click(function (evt) {
                        groupContainer.editableList('addItem', { type: 'ur_group', menuPage: menuPageNode.id });
                        evt.stopPropagation();
                        evt.preventDefault();
                    });

                    editButton.on('click', function (evt) {
                        RED.editor.editConfig('', menuPageNode.type, menuPageNode.id);
                        evt.stopPropagation();
                        evt.preventDefault();
                    });

                    item.groups.forEach(function (group) {
                        groupContainer.editableList('addItem', group);
                    });
                };

                var addGroup = function (container, i, item) {
                    if (!item.node.menuPage && item.menuPage) {
                        item.node.menuPage = item.menuPage;
                    }

                    item.widgets = item.widgets || [];

                    let groupNode = item.node;
                    elementParents[groupNode.id] = item.node.menuPage;
                    listElements[groupNode.id] = container;

                    RED.history.push({
                        t: 'add',
                        nodes: [item.node.id],
                        dirty: RED.nodes.dirty(),
                    });
                    RED.nodes.dirty(true);

                    if (RED.nodes.hasOwnProperty('updateConfigNodeUsers')) {
                        RED.nodes.updateConfigNodeUsers(item.node);
                    }

                    // title row
                    let titleRow = $('<div>', {
                        class: 'nr-db-sb-list-header nr-db-sb-group-list-header',
                    }).appendTo(container);

                    // handle
                    $('<i class="nr-db-sb-list-handle nr-db-sb-group-list-handle fa fa-bars"></i>').appendTo(titleRow);

                    // chevron
                    let chevron = $('<i class="fa fa-angle-down nr-db-sb-list-chevron">', {
                        style: 'width:10px;',
                    }).appendTo(titleRow);

                    // icon
                    $('<i class="nr-db-sb-icon nr-db-sb-group-icon fa fa-table"></i>').appendTo(titleRow);

                    //title
                    let title = $('<span class="nr-db-sb-title">')
                        .text(groupNode.name || groupNode.id || '')
                        .appendTo(titleRow);

                    // button group
                    let buttonGroup = $('<div>', {
                        class: 'nr-db-sb-list-header-button-group',
                    }).appendTo(titleRow);

                    let editButton = $(
                        '<a href="#" class="editor-button editor-button-small nr-db-sb-list-header-button"><i class="fa fa-pencil"></i> ' +
                            c_('layout.edit') +
                            '</a>'
                    ).appendTo(buttonGroup);

                    let content = $('<div>', { class: 'nr-db-sb-widget-list-container' }).appendTo(container);

                    if (!listStates.hasOwnProperty(groupNode.id) || !listStates[groupNode.id]) {
                        content.hide();
                        chevron.css({ 'transform': 'rotate(-90deg)' });
                        content.addClass('nr-db-sb-collapsed');
                        listStates[groupNode.id] = false;
                    } else {
                        listStates[groupNode.id] = true;
                    }

                    var widgetContainer = $('<ol>', { class: 'nr-db-sb-widget-list' })
                        .appendTo(content)
                        .editableList({
                            sortable: '.nr-db-sb-widget-list-header',
                            addButton: false,
                            height: 'auto',
                            connectWith: '.nr-db-sb-widget-list',
                            addItem: function (container, i, widgetNode) {
                                elementParents[widgetNode.id] = groupNode.id;
                                widgetNode.order = i + 1;
                                var titleRow = $('<div>', {
                                    class: 'nr-db-sb-list-header nr-db-sb-widget-list-header',
                                }).appendTo(container);
                                $(
                                    '<i class="nr-db-sb-list-handle nr-db-sb-widget-list-handle fa fa-bars"></i>'
                                ).appendTo(titleRow);
                                $('<i class="nr-db-sb-icon nr-db-sb-widget-icon fa fa-picture-o"></i>')
                                    .click(function (e) {
                                        e.preventDefault();
                                        RED.search.show(widgetNode.id);
                                    })
                                    .appendTo(titleRow);
                                var l = widgetNode._def.label;
                                try {
                                    l = (typeof l === 'function' ? l.call(widgetNode) : l) || '';
                                } catch (err) {
                                    console.log('Definition error: ' + d.type + '.label', err);
                                    l = d.type;
                                }
                                var title = $('<span class="nr-db-sb-title">').text(l).appendTo(titleRow);
                                listElements[widgetNode.id] = container;
                                var buttonGroup = $('<div>', {
                                    class: 'nr-db-sb-list-header-button-group',
                                }).appendTo(titleRow);
                                var editButton = $(
                                    '<a href="#" class="editor-button editor-button-small nr-db-sb-list-header-button"><i class="fa fa=pencil"></i> ' +
                                        c_('layout.edit') +
                                        '</a>'
                                ).appendTo(buttonGroup);
                                container.on('mouseover', function () {
                                    widgetNode.highlighted = true;
                                    widgetNode.dirty = true;
                                    RED.view.redraw();
                                });
                                container.on('mouseout', function () {
                                    widgetNode.highlighted = false;
                                    widgetNode.dirty = true;
                                    RED.view.redraw();
                                });
                                editButton.on('click', function (evt) {
                                    RED.editor.edit(widgetNode);
                                    evt.stopPropagation();
                                    evt.preventDefault();
                                });
                            },
                            sortItems: function (items) {
                                var historyEvents = [];
                                items.each(function (i, el) {
                                    var node = el.data('data');
                                    var hev = {
                                        t: 'edit',
                                        node: node,
                                        changes: {
                                            order: node.order,
                                            group: node.group,
                                        },
                                        dirty: node.dirty,
                                        changed: node.changed,
                                    };
                                    historyEvents.push(hev);
                                    var changed = false;
                                    if (node.order !== i + 1) {
                                        node.order = i + 1;
                                        changed = true;
                                    }
                                    if (node.group !== item.node.id) {
                                        var oldGroupNode = RED.nodes.node(node.group);
                                        if (oldGroupNode) {
                                            var index = oldGroupNode.users.indexOf(node);
                                            oldGroupNode.users.splice(index, 1);
                                        }
                                        node.group = item.node.id;
                                        item.node.users.push(node);
                                        changed = true;
                                    }
                                    if (changed) {
                                        node.dirty = true;
                                        node.changed = true;
                                    }
                                });
                                RED.history.push({
                                    t: 'multi',
                                    events: historyEvents,
                                });
                                RED.nodes.dirty(true);
                                RED.view.redraw();
                            },
                        });

                    widgetContainer.css('min-height', '5px');
                    console.log('addGroup groupNode: ', groupNode);
                    if (groupNode.id) {
                        groupLists[groupNode.id] = widgetContainer;
                    }

                    titleRow.click(titleToggle(groupNode.id, content, chevron));

                    editButton.on('click', function (evt) {
                        RED.editor.editConfig('', groupNode.type, groupNode.id);
                        evt.stopPropagation();
                        evt.preventDefault();
                    });

                    item.widgets.forEach(function (widget) {
                        widgetContainer.editableList('addItem', widget);
                    });
                };

                var addMenuEntity = function (container, i, item) {
                    // create node
                    item = makeNode(container, i, item);

                    switch (item.type) {
                        case 'ur_menu_item':
                            addMenuItem(container, i, item);
                            break;
                        case 'ur_menu_page':
                            addMenuPage(container, i, item);
                            break;
                        case 'ur_group':
                            addGroup(container, i, item);
                            break;
                        case 'ur_menu_link':
                            addMenuLink(container, i, item);
                        default:
                            console.log(
                                'Add Menu Entity Error: Incorrect or Missing node type.\n Got: ',
                                JSON.stringify(item, null, 2)
                            );
                    }
                };

                var menuItemContainer = $('<ol>', { class: 'nr-db-sb-menu-item-list' })
                    .appendTo(divTabs)
                    .editableList({
                        sortable: '.nr-db-sb-menu-item-list-header',
                        addButton: false,
                        // addItem: addTabOrLinkItem,
                        addItem: addMenuEntity,
                        sortItems: function (items) {
                            var historyEvents = [];
                            items.each(function (i, el) {
                                var itemData = el.data('data');
                                var node = itemData.node;
                                var hev = {
                                    t: 'edit',
                                    node: node,
                                    changes: {
                                        order: node.order,
                                    },
                                    dirty: node.dirty,
                                    changed: node.changed,
                                };
                                historyEvents.push(hev);
                                var changed = false;
                                if (node.order !== i + 1) {
                                    node.order = i + 1;
                                    changed = true;
                                }
                                if (changed) {
                                    node.dirty = true;
                                    node.changed = true;
                                }
                            });
                            RED.history.push({
                                t: 'multi',
                                events: historyEvents,
                            });
                            RED.nodes.dirty(true);
                            RED.view.redraw();
                        },
                    });

                // TODO: fix orphaned widgets - add check against type line 1661
                // var orphanedWidgets = $('<div>', { class: 'form-row' }).appendTo(layoutTab);
                // $(
                //     '<span><i class="fa fa-info-circle"></i> There <span id="nr-db-missing-group-count"></span> not in a group. Click <a id="nr-db-add-missing-groups" href="#">here</a> to create the missing groups</span>'
                // ).appendTo(orphanedWidgets);
                // orphanedWidgets.find('a').click(function (event) {
                //     var unknownGroups = {};
                //     RED.nodes.eachNode(function (node) {
                //         if (
                //             /^ur_/.test(node.type) &&
                //             node.type !== 'ur_link' &&
                //             node.type !== 'ur_toast' &&
                //             node.type !== 'ur_ui_control'
                //         ) {
                //             if (!RED.nodes.node(node.group)) {
                //                 var g = node.group || '_BLANK_';
                //                 unknownGroups[g] = unknownGroups[g] || [];
                //                 unknownGroups[g].push(node);
                //             }
                //         }
                //     });
                //     var menuItem = null;
                //     var menuPage = null;
                //     var menuItems = menuItemContainer.editableList('items');
                //     menuItems.first().each(function (i, el) {
                //         var menuItemData = el.data('data');
                //         menuItem = menuItemData.node;

                //         if (menuItemData.menuPages.length > 0) {
                //             // check type {}
                //             menuPage = menuItemData.menuPages[0].node;
                //         }
                //     });

                //     var hev = [];
                //     if (menuItem === null) {
                //         menuItem = {
                //             id: RED.nodes.id(),
                //             _def: RED.nodes.getType('ur_menu_item'),
                //             type: 'ur_menu_item',
                //             users: [],
                //             order: 0,
                //             name: 'Item',
                //             icon: 'dashboard',
                //         };
                //         RED.nodes.add(menuItem);
                //         hev.push(menuItem.id);
                //     }

                //     if (menuPage === null) {
                //         menuPage = {
                //             id: RED.nodes.id(),
                //             _def: RED.nodes.getType('ur_menu_page'),
                //             type: 'ur_menu_page',
                //             users: [],
                //             menuItem: menuItem.id,
                //             order: i + 1,
                //             name: 'Page',
                //             icon: 'dashboard',
                //         };
                //         RED.nodes.add(menuPage);
                //         hev.push(menuPage.id);
                //     }

                //     for (var groupId in unknownGroups) {
                //         if (unknownGroups.hasOwnProperty(groupId)) {
                //             var groupNode = {
                //                 id: RED.nodes.id(),
                //                 _def: RED.nodes.getType('ur_group'),
                //                 type: 'ur_group',
                //                 users: [],
                //                 menuPage: menuPage.id,
                //                 order: i + 1,
                //                 name: groupId === '_BLANK_' ? 'Group' : groupId,
                //                 width: 6,
                //                 disp: true,
                //             };
                //             hev.push(groupNode.id);
                //             RED.nodes.add(groupNode);
                //             RED.editor.validateNode(groupNode);
                //             if (RED.nodes.hasOwnProperty('updateConfigNodeUsers')) {
                //                 RED.nodes.updateConfigNodeUsers(groupNode);
                //             }
                //             var widgets = unknownGroups[groupId];
                //             for (var i = 0; i < widgets.length; i++) {
                //                 widgets[i].group = groupNode.id;
                //                 widgets[i].changed = true;
                //                 widgets[i].dirty = true;
                //                 if (RED.nodes.hasOwnProperty('updateConfigNodeUsers')) {
                //                     RED.nodes.updateConfigNodeUsers(widgets[i]);
                //                 }
                //                 RED.editor.validateNode(widgets[i]);
                //             }
                //         }
                //     }
                //     RED.history.push({
                //         t: 'add',
                //         nodes: hev,
                //         dirty: RED.nodes.dirty(),
                //     });
                //     RED.nodes.dirty(true);
                //     refresh();
                //     refreshOrphanedWidgets();
                //     RED.view.redraw();
                //     event.preventDefault();
                // });

                var listElements = {};
                var dashboard = [];
                var listStates = {};
                var elementParents = {};
                var awaitingGroups = {};
                var awaitingMenuItems = {};

                // helper function to get inner list
                function getInnerList(contents) {
                    let list = [];

                    contents.each(function (i, content) {
                        let entity;
                        let inner;
                        let contentData = content.data('data');

                        if (contentData.node) {
                            contentData = contentData.node;
                        }

                        switch (contentData.type) {
                            case 'ur_menu_item':
                                let itemContents = content
                                    .find('.nr-db-sb-menu-item-content-list')
                                    .editableList('items');
                                inner = getInnerList(itemContents);
                                entity = { id: contentData.id, children: inner };
                                break;
                            case 'ur_menu_page':
                                let groups = content.find('.nr-db-sb-group-list').editableList('items');
                                inner = getInnerList(groups);
                                entity = { id: contentData.id, groups: inner };
                                break;
                            case 'ur_group':
                                let widgets = content.find('.nr-db-sb-widget-list').editableList('items');
                                inner = getInnerList(widgets);
                                entity = { id: contentData.id, widgets: inner };
                                break;
                            default:
                                entity = contentData.id;
                        }

                        list.push(entity);
                    });

                    return list;
                }

                function getCurrentList() {
                    var currentList = [];
                    var menuItems = menuItemContainer.editableList('items');
                    // console.log('getCurrentList() menuItems: ', menuItems);

                    var open = false;
                    menuItems.each(function (i, el) {
                        let menuItemData = el.data('data');
                        // console.log('getCurrentList() menuItemData: ', menuItemData);
                        let menuItemContents = el.find('.nr-db-sb-menu-item-content-list').editableList('items');
                        let innerList = getInnerList(menuItemContents) || [];

                        currentList.push({ id: menuItemData.node.id, children: innerList });
                    });

                    return currentList;
                }

                // TODO: fix orphaned widgets
                // function refreshOrphanedWidgets() {
                //     var unknownGroups = {};
                //     var count = 0;
                //     RED.nodes.eachNode(function (node) {
                //         if (
                //             /^ur_/.test(node.type) &&
                //             node.type !== 'ur_link' &&
                //             node.type !== 'ur_toast' &&
                //             node.type !== 'ur_ui_control' &&
                //             node.type === 'ur_template' &&
                //             node.templateScope !== 'global'
                //         ) {
                //             console.log('refreshOrphanedWidgets passing node: ', node);
                //             if (!RED.nodes.node(node.group)) {
                //                 var g = node.group || '_BLANK_';
                //                 unknownGroups[g] = unknownGroups[g] || [];
                //                 unknownGroups[g].push(node);
                //                 count++;
                //             }
                //         }
                //     });

                //     if (count > 0) {
                //         orphanedWidgets.show();
                //         $('#nr-db-missing-group-count').text(
                //             (count === 1 ? 'is ' : 'are ') + count + ' widget' + (count === 1 ? '' : 's')
                //         );
                //     } else {
                //         orphanedWidgets.hide();
                //     }
                // }

                function refresh() {
                    console.log('refresh called!');
                    var currentList = getCurrentList();
                    var newList = [];
                    dashboard = [];
                    var menuItems = {}; // a dictionary of "root-level" menu-items
                    var menuItemItems = {}; // a dictionary of menu-items that have a parent menuItem
                    var menuPages = {}; // a dictionary of menu-pages
                    var groups = {}; // a dictionary of groups
                    var elements = []; // a dictionary of widgets
                    var groupElements = {}; // a dictionary of widgets by parent group ID
                    var menuPageGroups = {}; // a dictionary of groups by parent menuPage
                    var menuItemChildren = {}; // a dictionary of any menu-item's children <key: parent menuItem's id, value: array of children (items & pages)>
                    var groupId;
                    var group;
                    var menuPageId;
                    var menuPage;
                    var menuItemId;
                    var menuItem;
                    var unknownGroups = 0;

                    var find;

                    // Find all the menuItems, menuPages, and groups
                    RED.nodes.eachConfig(function (node) {
                        switch (node.type) {
                            case 'ur_link': {
                                // TODO: ur_link stuffs
                                break;
                            }
                            case 'ur_menu_item': {
                                if (!node.menuItem) {
                                    menuItems[node.id] = node;
                                } else {
                                    menuItemItems[node.id] = node;
                                }
                                break;
                            }
                            case 'ur_menu_page': {
                                menuPages[node.id] = node;
                                break;
                            }
                            case 'ur_group': {
                                groups[node.id] = node;
                                break;
                            }
                            case 'ur_spacer': {
                                if (groups.hasOwnProperty(node.group)) {
                                    groupElements[node.group] = groupElements[node.group] || [];
                                    groupElements[node.group].push(node);
                                }
                                break;
                            }
                        }
                    });

                    for (menuItemId in menuItemItems) {
                        if (menuItemItems.hasOwnProperty(menuItemId)) {
                            menuItem = menuItemItems[menuItemId];
                            if (
                                menuItems.hasOwnProperty(menuItem.menuItem) ||
                                menuItemItems.hasOwnProperty(menuItem.menuItem)
                            ) {
                                menuItemChildren[menuItem.menuItem] = menuItemChildren[menuItem.menuItem] || [];
                                menuItemChildren[menuItem.menuItem].push(menuItem);
                            }
                        }
                    }

                    for (menuPageId in menuPages) {
                        if (menuPages.hasOwnProperty(menuPageId)) {
                            menuPage = menuPages[menuPageId];
                            if (
                                menuItems.hasOwnProperty(menuPage.menuItem) ||
                                menuItemItems.hasOwnProperty(menuPage.menuItem)
                            ) {
                                menuItemChildren[menuPage.menuItem] = menuItemChildren[menuPage.menuItem] || [];
                                menuItemChildren[menuPage.menuItem].push(menuPage);
                            }
                        }
                    }

                    for (groupId in groups) {
                        if (groups.hasOwnProperty(groupId)) {
                            group = groups[groupId];
                            if (menuPages.hasOwnProperty(group.menuPage)) {
                                // This group belongs to a menuPage
                                menuPageGroups[group.menuPage] = menuPageGroups[group.menuPage] || [];
                                menuPageGroups[group.menuPage].push(group);
                            } else {
                                unknownGroups++;
                            }
                        }
                    }
                    // Find all ui widgets - list them by their group id
                    RED.nodes.eachNode(function (node) {
                        if (/^ur_/.test(node.type)) {
                            if (groups.hasOwnProperty(node.group)) {
                                groupElements[node.group] = groupElements[node.group] || [];
                                groupElements[node.group].push(node);
                            } else if (
                                node.type !== 'ur_toast' &&
                                node.type !== 'ur_ui_control' &&
                                node.type === 'ur_template' &&
                                node.templateScope !== 'global'
                            ) {
                                unknownGroups++;
                            }
                        }
                    });
                    // TODO: fix orphaned widgets
                    // if (unknownGroups > 0) {
                    //     $('#nr-db-missing-group-count').text(
                    //         (unknownGroups === 1 ? 'is ' : 'are ') +
                    //             unknownGroups +
                    //             ' widget' +
                    //             (unknownGroups === 1 ? '' : 's')
                    //     );
                    //     orphanedWidgets.show();
                    // } else {
                    //     orphanedWidgets.hide();
                    // }
                    // Sort each group's array of widgets
                    for (groupId in groupElements) {
                        if (groupElements.hasOwnProperty(groupId)) {
                            group = groupElements[groupId];
                            groupElements[groupId] = group
                                .map(function (v, i) {
                                    console.log('sorting... ', v);
                                    return { n: v, i: i };
                                })
                                .sort(function (A, B) {
                                    if (A.n.order < B.n.order) {
                                        return A.n.order !== 0 ? -1 : 1;
                                    }
                                    if (A.n.order > B.n.order) {
                                        return B.n.order !== 0 ? 1 : -1;
                                    }
                                    return A.i - B.i;
                                })
                                .map(function (v) {
                                    return v.n;
                                });
                        }
                    }
                    // Sort each menuPage's array of groups
                    for (menuPageId in menuPageGroups) {
                        if (menuPageGroups.hasOwnProperty(menuPageId)) {
                            menuPage = menuPageGroups[menuPageId];
                            menuPageGroups[menuPageId] = menuPage
                                .map((v, i) => {
                                    return { n: v, i: i };
                                })
                                .sort((A, B) => {
                                    if (A.n.order < B.n.order) {
                                        return -1;
                                    }
                                    if (A.n.order > B.n.order) {
                                        return 1;
                                    }
                                    return A.i - B.i;
                                })
                                .map((v) => {
                                    return v.n;
                                });
                        }
                    }
                    // Sort each menuItem's array of children
                    for (menuItemId in menuItemChildren) {
                        if (menuItemChildren.hasOwnProperty(menuItemId)) {
                            menuItem = menuItemChildren[menuItemId];
                            menuItemChildren[menuItemId] = menuItem
                                .map(function (v, i) {
                                    return { n: v, i: i };
                                })
                                .sort(function (A, B) {
                                    if (A.n.order < B.n.order) {
                                        return -1;
                                    }
                                    if (A.n.order > B.n.order) {
                                        return 1;
                                    }
                                    return A.i - B.i;
                                })
                                .map(function (v) {
                                    return v.n;
                                });
                        }
                    }
                    var menuItemIds = Object.keys(menuItems)
                        .map(function (v, i) {
                            return { n: menuItems[v], i: i };
                        })
                        .sort(function (A, B) {
                            if (A.n.order < B.n.order) {
                                return -1;
                            }
                            if (A.n.order > B.n.order) {
                                return 1;
                            }
                            return A.i - B.i;
                        })
                        .map(function (v) {
                            return v.n.id;
                        });

                    var getNestedChildren = function (parent, format) {
                        let result = [];

                        if (!format) {
                            format = 'dashboard';
                        }

                        // console.log('getNestedChildren parent: ', parent);

                        switch (parent.type) {
                            case 'ur_menu_item':
                                if (menuItemChildren.hasOwnProperty(parent.id)) {
                                    let children = [...menuItemChildren[parent.id]];

                                    for (let child of children) {
                                        if (child.type === 'ur_menu_item') {
                                            let mi =
                                                format === 'dashboard'
                                                    ? { node: { ...child, menuItem: parent.id } }
                                                    : { id: child.id };
                                            mi.children = getNestedChildren(child, format);
                                            result.push(mi);
                                        } else if (child.type === 'ur_menu_page') {
                                            let mp =
                                                format === 'dashboard'
                                                    ? { node: { ...child, menuItem: parent.id } }
                                                    : { id: child.id };
                                            mp.groups = getNestedChildren(child, format);
                                            result.push(mp);
                                        }
                                    }
                                }
                                break;
                            case 'ur_menu_page':
                                if (menuPageGroups.hasOwnProperty(parent.id)) {
                                    let groups = [...menuPageGroups[parent.id]];

                                    for (let group of groups) {
                                        let g =
                                            format === 'dashboard'
                                                ? { node: { ...group, menuPage: parent.id } }
                                                : { id: group.id };
                                        g.widgets = getNestedChildren(group, format);
                                        result.push(g);
                                    }
                                }
                                break;
                            case 'ur_group':
                                if (groupElements.hasOwnProperty(parent.id)) {
                                    result =
                                        format === 'dashboard'
                                            ? groupElements[parent.id]
                                            : groupElements[parent.id].map((element) => element.id);
                                }
                                break;
                        }

                        return result;
                    };

                    menuItemIds.forEach(function (menuItemId) {
                        let menuItemForDashboard = { node: menuItems[menuItemId] };
                        menuItemForDashboard.children = getNestedChildren(menuItems[menuItemId]);
                        dashboard.push(menuItemForDashboard);

                        // build newList for comparison against currentList
                        let menuItemForNewList = { id: menuItemId };
                        menuItemForNewList.children = getNestedChildren(menuItems[menuItemId], 'new-list');
                        newList.push(menuItemForNewList);
                    });

                    // console.log('menuItems: ', menuItems);
                    // console.log('menuPages: ', menuPages);
                    // console.log('menuItemChildren: ', menuItemChildren);
                    console.log('dashboard: ', dashboard);
                    console.log('newList: ', newList);
                    console.log('currentList: ', currentList);

                    if (JSON.stringify(newList) != JSON.stringify(currentList)) {
                        console.log('currentList does not match newList...');
                        listElements = {};
                        groupLists = {};
                        menuPageLists = {};
                        menuItemLists = {};
                        menuItems = {};
                        menuPages = {};
                        groups = {};
                        elementParents = {};
                        menuItemContainer.empty();
                        dashboard.forEach(function (menuItem) {
                            menuItemContainer.editableList('addItem', menuItem);
                        });
                    }
                    ensureDashboardNode(true);
                    if (globalDashboardNode) {
                        $('#nr-db-field-title').val(globalDashboardNode.site.name);
                        $('#nr-db-field-allowSwipe').val(globalDashboardNode.site.allowSwipe || 'false');
                        $('#nr-db-field-allowTempTheme').val(globalDashboardNode.site.allowTempTheme || 'true');
                        $('#nr-db-field-hideToolbar').val(globalDashboardNode.site.hideToolbar || 'false');
                        $('#nr-db-field-dateFormat').val(globalDashboardNode.site.dateFormat);

                        if (typeof globalDashboardNode.site.sizes !== 'object') {
                            globalDashboardNode.site.sizes = sizes;
                        }
                        $('#nr-db-field-sx').val(globalDashboardNode.site.sizes.sx);
                        $('#nr-db-field-sy').val(globalDashboardNode.site.sizes.sy);
                        $('#nr-db-field-px').val(globalDashboardNode.site.sizes.px);
                        $('#nr-db-field-py').val(globalDashboardNode.site.sizes.py);
                        $('#nr-db-field-cx').val(globalDashboardNode.site.sizes.cx);
                        $('#nr-db-field-cy').val(globalDashboardNode.site.sizes.cy);
                        $('#nr-db-field-gx').val(globalDashboardNode.site.sizes.gx);
                        $('#nr-db-field-gy').val(globalDashboardNode.site.sizes.gy);

                        if (typeof globalDashboardNode.theme.angularTheme !== 'object') {
                            globalDashboardNode.theme.angularTheme = aTheme;
                        }
                        $('#nr-db-field-angPrimary').val(globalDashboardNode.theme.angularTheme.primary || 'indigo');
                        $('#nr-db-field-angAccents').val(globalDashboardNode.theme.angularTheme.accents || 'blue');
                        $('#nr-db-field-angWarn').val(globalDashboardNode.theme.angularTheme.warn || 'red');
                        $('#nr-db-field-angBackground').val(
                            globalDashboardNode.theme.angularTheme.background || 'grey'
                        );
                        $('#nr-db-field-angLook').val(globalDashboardNode.theme.angularTheme.palette || 'light');

                        $('#nr-db-field-theme').val(globalDashboardNode.theme.name);
                        $('#ui-sidebar-name').val(globalDashboardNode.theme.customTheme.name);
                        if (globalDashboardNode.theme.name === 'theme-custom') {
                            $('#custom-theme-library-container').show();
                            $('#custom-theme-settings').show();
                        } else {
                            $('#custom-theme-library-container').hide();
                            $('#custom-theme-settings').hide();
                        }
                        if ($('#nr-db-field-allowTempTheme').val() === 'none') {
                            ulDashboardTabs.children().eq(2).addClass('hidden');
                            ulDashboardTabs.children().eq(3).removeClass('hidden');
                        } else {
                            ulDashboardTabs.children().eq(2).removeClass('hidden');
                            ulDashboardTabs.children().eq(3).addClass('hidden');
                        }

                        //set colour start
                        if (typeof globalDashboardNode.theme.name !== 'string') {
                            globalDashboardNode.theme.name = 'theme-light';
                        }
                        var currentTheme = globalDashboardNode.theme.name.split('-')[1];
                        var startingValue = globalDashboardNode.theme[currentTheme + 'Theme'].baseColor;
                        setColourPickerColour('base-color', startingValue);
                        $('#nr-db-field-font').val(globalDashboardNode.theme[currentTheme + 'Theme'].baseFont);
                        generateColours(startingValue);
                        if (
                            globalDashboardNode.theme.name === 'theme-light' ||
                            globalDashboardNode.theme.name === 'theme-dark'
                        ) {
                            addLightAndDarkResetButton('base-color', $('#base-settings-ul').children().first());
                        }

                        if (editor === undefined) {
                            editor = RED.editor.createEditor({
                                id: 'nr-db-field-format-editor',
                                mode: 'ace/mode/javascript',
                                value: JSON.stringify({
                                    theme: globalDashboardNode.theme.themeState,
                                    site: globalDashboardNode.site,
                                }),
                            });

                            RED.library.create({
                                url: 'themes', // where to get the data from
                                type: 'theme', // the type of object the library is for
                                editor: editor, // the field name the main text body goes to
                                mode: 'ace/mode/javascript',
                                fields: ['name'],
                                elementPrefix: 'ui-sidebar-',
                            });
                        }

                        editor.on('input', function () {
                            // Check for any changes on the editor object
                            // i.e. has the theme been customized compared
                            // to what is stored
                            var editorObject = JSON.parse(editor.getValue());
                            // var objectsEqual = true;
                            // var keysEqual = true;
                            // var editorKeys = Object.keys(editorObject);
                            // var themeKeys = Object.keys(editorObject.theme);
                            // var siteKeys = Object.keys(editorObject.site);
                            // var dashNodeKeys = Object.keys(globalDashboardNode.theme.themeState);

                            // // Test equality
                            // for (var i=0; i<themeKeys.length; i++) {
                            //     if (themeKeys[i] !== dashNodeKeys[i]) {
                            //         keysEqual = false;
                            //         break;
                            //     }
                            // }
                            // if (keysEqual) {
                            //     for (var j=0; j<themeKeys.length; j++) {
                            //         var key = themeKeys[j];
                            //         if (editorObject.theme[key] !== globalDashboardNode.theme.themeState[key]) {
                            //             objectsEqual = false;
                            //             break;
                            //         }
                            //     }
                            // }
                            //
                            // if (!objectsEqual) {
                            //     globalDashboardNode.theme.themeState = editorObject.theme;
                            // }
                            //
                            // //If custom theme is chosen, update the elements and current state
                            // if (globalDashboardNode.theme.name === 'theme-custom') {
                            //     //globalDashboardNode.theme.customTheme.baseColor = globalDashboardNode.theme.themeState['base-color'].default;
                            //     generateColours(globalDashboardNode.theme.customTheme.baseColor);
                            //     //setColourPickerColour("base-color", globalDashboardNode.theme.customTheme.baseColor);
                            //     if (!objectsEqual) { RED.nodes.dirty(true); }
                            // }

                            //Update theme object if necessary
                            if (
                                JSON.stringify(editorObject.theme) !==
                                JSON.stringify(globalDashboardNode.theme.themeState)
                            ) {
                                globalDashboardNode.theme.themeState = editorObject.theme;
                                if ($('#ui-sidebar-name').val() !== globalDashboardNode.theme.customTheme.name) {
                                    globalDashboardNode.theme.customTheme.name = $('#ui-sidebar-name').val();
                                    globalDashboardNode.theme.customTheme.baseColor =
                                        globalDashboardNode.theme.themeState['base-color'].value;
                                    setColourPickerColour(
                                        'base-color',
                                        globalDashboardNode.theme.customTheme.baseColor
                                    );
                                    generateColours(globalDashboardNode.theme.themeState['base-color'].value);
                                    RED.nodes.dirty(true);
                                }
                            }
                            if (JSON.stringify(aTheme) !== JSON.stringify(globalDashboardNode.theme.angularTheme)) {
                                globalDashboardNode.theme.angularTheme = aTheme;
                            }

                            //Update site object if necessary
                            if (JSON.stringify(editorObject.site) !== JSON.stringify(globalDashboardNode.site)) {
                                globalDashboardNode.site = editorObject.site;
                                $('#nr-db-field-title').val(globalDashboardNode.site.name);
                                $('#nr-db-field-hideToolbar').val(globalDashboardNode.site.hideToolbar);
                                $('#nr-db-field-allowSwipe').val(globalDashboardNode.site.allowSwipe);
                                $('#nr-db-field-allowTempTheme').val(globalDashboardNode.site.allowTempTheme);
                                $('#nr-db-field-dateFormat').val(globalDashboardNode.site.dateFormat);
                                $('#nr-db-field-sx').val(globalDashboardNode.site.sizes.sx);
                                $('#nr-db-field-sy').val(globalDashboardNode.site.sizes.sy);
                                $('#nr-db-field-px').val(globalDashboardNode.site.sizes.px);
                                $('#nr-db-field-py').val(globalDashboardNode.site.sizes.py);
                                $('#nr-db-field-gx').val(globalDashboardNode.site.sizes.gx);
                                $('#nr-db-field-gy').val(globalDashboardNode.site.sizes.gy);
                                $('#nr-db-field-cx').val(globalDashboardNode.site.sizes.cx);
                                $('#nr-db-field-cy').val(globalDashboardNode.site.sizes.cy);
                                RED.nodes.dirty(true);
                            }
                        });
                    }
                    awaitingGroups = {};
                    awaitingMenuItems = {};
                }

                RED.sidebar.addTab({
                    id: 'dashboard',
                    label: c_('label.dashboard'),
                    name: 'Dashboard',
                    content: content,
                    closeable: true,
                    pinned: true,
                    iconClass: 'fa fa-bar-chart',
                    disableOnEdit: true,
                    onchange: function () {
                        refresh();
                    },
                });

                editSaveEventHandler = function (node) {
                    console.log('editSaveEventHandler called by: ', node);
                    // console.log('editSaveEventHandler() menuItemLists: ', menuItemLists);
                    // console.log('editSaveEventHandler() menuPageLists: ', menuPageLists);
                    // console.log('editSaveEventHandler() groupLists: ', groupLists);
                    console.log('editSaveEventHandler() listElements: ', listElements);
                    if (/^ur_/.test(node.type)) {
                        if (node.type === 'ur_menu_item' || node.type === 'ur_menu_page' || node.type === 'ur_group') {
                            if (listElements[node.id]) {
                                // Existing element
                                listElements[node.id]
                                    .children('.nr-db-sb-list-header')
                                    .find('.nr-db-sb-title')
                                    .text(node.name || node.id);
                                if (node.type === 'ur_group') {
                                    refresh();
                                } else {
                                    if (node.hidden === true) {
                                        listElements[node.id]
                                            .children('.nr-db-sb-list-header')
                                            .find('.nr-db-sb-title')
                                            .addClass('nr-db-sb-title-hidden');
                                    } else {
                                        listElements[node.id]
                                            .children('.nr-db-sb-list-header')
                                            .find('.nr-db-sb-title')
                                            .removeClass('nr-db-sb-title-hidden');
                                    }
                                    if (node.disabled === true) {
                                        listElements[node.id]
                                            .children('.nr-db-sb-list-header')
                                            .find('.nr-db-sb-title')
                                            .addClass('nr-db-sb-title-disabled');
                                    } else {
                                        listElements[node.id]
                                            .children('.nr-db-sb-list-header')
                                            .find('.nr-db-sb-title')
                                            .removeClass('nr-db-sb-title-disabled');
                                    }
                                }
                            } else if (node.type === 'ur_menu_item') {
                                if (!node.menuItem) {
                                    // Adding a root menuItem
                                    menuItemContainer.editableList('addItem', { node: node, children: [] });
                                } else if (menuItemLists[node.menuItem]) {
                                    // Adding a child menuItem
                                    menuItemLists[node.menuItem].editableList('addItem', {
                                        node: node,
                                        child: true,
                                        children: [],
                                    });
                                }
                            } else if (node.type === 'ur_menu_page') {
                                // Adding a menuPage
                                if (menuItemLists[node.menuItem]) {
                                    menuItemLists[node.menuItem].editableList('addItem', { node: node, groups: [] });
                                }
                            } else {
                                // Adding a group
                                if (menuPageLists[node.menuPage]) {
                                    menuPageLists[node.menuPage].editableList('addItem', {
                                        node: node,
                                        widgets: [],
                                    });
                                }
                            }
                        } else if (node.type === 'ur_link') {
                            if (listElements[node.id]) {
                                var container = listElements[node.id];
                                container.find('.nr-db-sb-link-name').text(node.name || 'untitled');
                                container.find('.nr-db-sb-link-url').text(node.link);
                            }
                        } else {
                            // TODO: fix orphaned widgets
                            // refreshOrphanedWidgets();
                            console.log('saving a widget!');
                            console.log('widget sees elementParents: ', elementParents);
                            console.log('widget sees groupLists: ', groupLists);
                            if (listElements[node.id]) {
                                if (node.group != elementParents[node.id]) {
                                    // Moved to a different group
                                    if (groupLists[elementParents[node.id]]) {
                                        groupLists[elementParents[node.id]].editableList(
                                            'removeItem',
                                            listElements[node.id].data('data')
                                        );
                                    }
                                    if (groupLists[node.group]) {
                                        groupLists[node.group].editableList('removeItem', node);
                                        groupLists[node.group].editableList('addItem', node);
                                    }
                                } else {
                                    var l = node._def.label;
                                    try {
                                        l = (typeof l === 'function' ? l.call(node) : l) || '';
                                    } catch (err) {
                                        console.log('Definition error: ' + d.type + '.label', err);
                                        l = d.type;
                                    }
                                    listElements[node.id]
                                        .children('.nr-db-sb-list-header')
                                        .find('.nr-db-sb-title')
                                        .text(l);
                                }
                            } else {
                                if (groupLists[node.group]) {
                                    if (node.order === 0) {
                                        console.log('editSaveEventHandler groupLists.editableList properties:');
                                        console.log('  items: ', groupLists[node.group].editableList('items'));
                                        console.log('  length: ', groupLists[node.group].editableList('length'));
                                        node.order = groupLists[node.group].editableList('length');
                                        console.log('updated node.order: ', node.order);
                                    }
                                    groupLists[node.group].editableList('addItem', node);
                                }
                            }
                        }
                    }
                };
                RED.events.on('editor:save', editSaveEventHandler);

                // Dashboard layout tool
                // layoutUpdateEventHandler = function (node) {
                //     if (
                //         /^ur_/.test(node.type) &&
                //         node.type !== 'ur_link' &&
                //         node.type !== 'ur_toast' &&
                //         node.type !== 'ur_ui_control' &&
                //         node.type !== 'ur_audio' &&
                //         node.type !== 'ur_base' &&
                //         node.type !== 'ur_group' &&
                //         node.type !== 'ur_menu_page' &&
                //         node.type !== 'ur_menu_item'
                //     ) {
                //         if (listElements[node.id]) {
                //             if (node.group != elementParents[node.id]) {
                //                 // Moved to a different group
                //                 if (groupLists[elementParents[node.id]]) {
                //                     groupLists[elementParents[node.id]].editableList(
                //                         'removeItem',
                //                         listElements[node.id].data('data')
                //                     );
                //                 }
                //                 if (groupLists[node.group]) {
                //                     groupLists[node.group].editableList('removeItem', node);
                //                     groupLists[node.group].editableList('addItem', node);
                //                     groupLists[node.group].editableList('sort', function (a, b) {
                //                         return a.order - b.order;
                //                     });
                //                 }
                //             } else {
                //                 groupLists[node.group].editableList('sort', function (a, b) {
                //                     return a.order - b.order;
                //                 });
                //             }
                //         }
                //     }
                // };
                // RED.events.on('layout:update', layoutUpdateEventHandler);

                var pendingAdd = [];
                var pendingAddTimer = null;

                // handlePendingAdds working correctly now. Added
                function handlePendingAdds() {
                    var hasMenuItems = false;
                    var hasChildMenuItems = false;
                    var hasMenuPages = false;
                    var hasGroups = false;
                    pendingAdd.sort(function (A, B) {
                        hasMenuItems = // has root level menu_items
                            hasMenuItems ||
                            (A.type === 'ur_menu_item' && !A.menuItem) ||
                            (B.type === 'ur_menu_item' && !B.menuItem);
                        hasChildMenuItems = // has non-root level menu_items
                            hasChildMenuItems ||
                            (A.type === 'ur_menu_item' && A.menuItem) ||
                            (B.type === 'ur_menu_item' && B.menuItem);
                        hasMenuPages = hasMenuPages || A.type === 'ur_menu_page' || B.type === 'ur_menu_page';
                        hasGroups = hasGroups || A.type === 'ur_group' || B.type === 'ur_group';
                        if (A.type === B.type) {
                            if (A.type === 'ur_menu_item') {
                                if (A.menuItem == undefined && B.menuItem !== undefined) {
                                    return -1;
                                } else if (A.menuItem !== undefined && B.menuItem == undefined) {
                                    return 1;
                                }
                            }
                            return 0;
                        }
                        if (A.type === 'ur_menu_item') {
                            return -1;
                        } else if (B.type === 'ur_menu_item') {
                            return 1;
                        } else if (A.type === 'ur_menu_page') {
                            return -1;
                        } else if (B.type === 'ur_menu_page') {
                            return 1;
                        } else if (A.type === 'ur_group') {
                            return -1;
                        } else if (B.type === 'ur_group') {
                            return 1;
                        }
                        return 0;
                    });
                    // console.log('sorted pendingAdd: ', pendingAdd);
                    // console.log("pendingAdd's view of menuItemLists: ", menuItemLists);
                    for (var i = 0; i < pendingAdd.length; i++) {
                        var node = pendingAdd[i];
                        if (node.type === 'ur_menu_item' && !node.menuItem) {
                            menuItemContainer.editableList('addItem', { node: node, children: [] });
                        } else {
                            if (hasMenuItems) {
                                // We've added some menuItems, need to give jquery time to add the lists
                                pendingAdd = pendingAdd.slice(i);
                                pendingAddTimer = setTimeout(handlePendingAdds, 50);
                                return;
                            }
                            if (node.type === 'ur_menu_item' && node.menuItem) {
                                if (menuItemLists[node.menuItem]) {
                                    menuItemLists[node.menuItem].editableList('addItem', { node: node, children: [] });
                                }
                            } else {
                                // we've added some child menuItems, need to give jquery time to add the lists
                                if (hasChildMenuItems) {
                                    pendingAdd = pendingAdd.slice(i);
                                    pendingAddTimer = setTimeout(handlePendingAdds, 50);
                                    return;
                                }
                                if (node.type === 'ur_menu_page') {
                                    if (menuItemLists[node.menuItem]) {
                                        menuItemLists[node.menuItem].editableList('addItem', {
                                            node: node,
                                            groups: [],
                                        });
                                    }
                                } else {
                                    if (hasMenuPages) {
                                        // We've added some menuPages, need to give jquery time to add the lists
                                        pendingAdd = pendingAdd.slice(i);
                                        pendingAddTimer = setTimeout(handlePendingAdds, 50);
                                        return;
                                    }
                                    if (node.type === 'ur_group') {
                                        if (menuPageLists[node.menuPage]) {
                                            menuPageLists[node.menuPage].editableList('addItem', {
                                                node: node,
                                                widgets: [],
                                            });
                                        }
                                    } else {
                                        if (hasGroups) {
                                            // We've added some groups, need to give jquery time to add the lists
                                            pendingAdd = pendingAdd.slice(i);
                                            pendingAddTimer = setTimeout(handlePendingAdds, 50);
                                            return;
                                        }
                                        if (groupLists[node.group]) {
                                            groupLists[node.group].editableList('addItem', node);
                                        } else {
                                            // TODO: fix orphaned widgets
                                            // refreshOrphanedWidgets();
                                        }
                                    }
                                }
                            }
                        }
                    }
                    pendingAdd = [];
                }

                nodesAddEventHandler = function (node) {
                    // console.log('nodesAddEventHandler called by: ', node);
                    if (/^ur_/.test(node.type) && !listElements[node.id]) {
                        pendingAdd.push(node);
                        clearTimeout(pendingAddTimer);
                        pendingAddTimer = setTimeout(handlePendingAdds, 100);
                    }
                };
                RED.events.on('nodes:add', nodesAddEventHandler);

                nodesRemoveEventHandler = function (node) {
                    console.log('nodesRemoveEventHandler called by: ', node);
                    if (/^ur_/.test(node.type)) {
                        if (node.type === 'ur_menu_item' || node.type === 'ur_link') {
                            if (listElements[node.id]) {
                                if (node.menuItem) {
                                    menuItemLists[node.menuItem].editableList(
                                        'removeItem',
                                        listElements[node.id].data('data')
                                    );
                                } else {
                                    menuItemContainer.editableList('removeItem', listElements[node.id].data('data'));
                                }
                                delete menuItemLists[node.id];
                            }
                        } else if (node.type === 'ur_menu_page') {
                            if (menuItemLists[node.menuItem] && listElements[node.id]) {
                                menuItemLists[node.menuItem].editableList(
                                    'removeItem',
                                    listElements[node.id].data('data')
                                );
                            }
                            delete menuPageLists[node.id];
                        } else if (node.type === 'ur_group') {
                            if (menuPageLists[node.menuPage] && listElements[node.id]) {
                                menuPageLists[node.menuPage].editableList(
                                    'removeItem',
                                    listElements[node.id].data('data')
                                );
                            }
                            delete groupLists[node.id];
                        } else {
                            if (groupLists[node.group]) {
                                groupLists[node.group].editableList('removeItem', node);
                            }
                        }
                        // TODO: fix orphaned widgets
                        // refreshOrphanedWidgets();
                        delete listElements[node.id];
                    }
                };
                RED.events.on('nodes:remove', nodesRemoveEventHandler);
            },
        });

        $.widget('nodereddashboard.elementSizerByNum', {
            _create: function () {
                var that = this;
                var has_height = this.options.has_height;
                var pos = this.options.pos;
                var c_width = has_height ? '15%' : '6%';
                var container = $('<div>')
                    .css({
                        position: 'absolute',
                        background: 'white',
                        padding: '10px 10px 10px 10px',
                        border: '1px solid grey',
                        zIndex: '20',
                        borderRadius: '4px',
                        display: 'none',
                        width: c_width,
                    })
                    .appendTo(document.body);
                var box0 = $('<div>')
                    .css({
                        fontSize: '13px',
                        color: '#aaa',
                        float: 'left',
                        paddingTop: '1px',
                    })
                    .appendTo(container);

                var width = $(this.options.width).val();
                var height = has_height ? $(this.options.height).val() : undefined;
                var max_w = '';
                var groupNode = this.options.groupNode;
                if (groupNode) {
                    max_w = 'max="' + groupNode.width + '"';
                }
                width = width > 0 ? width : 1;
                height = height > 0 ? height : 1;
                var in0 = $('<input type="number" min="1" ' + max_w + '>')
                    .css('width', has_height ? '45%' : '100%')
                    .val(width)
                    .appendTo(box0);
                if (has_height) {
                    var pad = $('<span>').text(' x ').appendTo(box0);
                    var in1 = $('<input type="number" min="1">').css('width', '45%').val(height).appendTo(box0);
                }
                var closeTimer;
                var closeFunc = function () {
                    var w = in0.val();
                    var h = has_height ? in1.val() : undefined;
                    var label = that.options.label;
                    label.text(w + (has_height ? ' x ' + h : ''));
                    $(that.options.width).val(w).change();
                    if (has_height) {
                        $(that.options.height).val(h).change();
                    }
                    that.destroy();
                };
                container.keypress(function (e) {
                    if (e.which === 13) {
                        // pressed ENTER
                        container.fadeOut(100, closeFunc);
                    }
                });
                container.on('mouseleave', function (e) {
                    closeTimer = setTimeout(function () {
                        container.fadeOut(200, closeFunc);
                    }, 100);
                });
                container.on('mouseenter', function (e) {
                    clearTimeout(closeTimer);
                });
                container.css({
                    top: pos.top - 10 + 'px',
                    left: pos.left + 10 + 'px',
                });
                container.fadeIn(200);
            },
        });

        $.widget('nodereddashboard.elementSizer', {
            _create: function () {
                // console.log('elementSizer this: ', this);
                var that = this;
                var gridWidth = 12;
                var width = parseInt($(this.options.width).val() || 0);
                // console.log('elementSizer width: ', width);
                var height = parseInt(this.options.hasOwnProperty('height') ? $(this.options.height).val() : '1') || 0;
                var hasAuto = !this.options.hasOwnProperty('auto') || this.options.auto;

                this.element.css({
                    minWidth: this.element.height() + 4,
                });
                var auto_text = c_('auto');
                var sizeLabel =
                    width === 0 && height === 0
                        ? auto_text
                        : width + (this.options.hasOwnProperty('height') ? ' x ' + height : '');
                this.element.text(sizeLabel).on('mousedown', function (evt) {
                    evt.stopPropagation();
                    evt.preventDefault();

                    var width = parseInt($(that.options.width).val() || 0);
                    var height =
                        parseInt(that.options.hasOwnProperty('height') ? $(that.options.height).val() : '1') || 0;
                    // var maxWidth = 6;
                    var maxWidth = 12;
                    var maxHeight = 1;
                    var fixedWidth = true;
                    var fixedHeight = true;
                    // var fixedWidth = false;
                    // var fixedHeight = false;
                    // var group = $(that.options.group).val();
                    // if (group) {
                    //     var groupNode = RED.nodes.node(group);
                    //     if (groupNode) {
                    //         gridWidth = Math.max(6, groupNode.width, +width);
                    //         maxWidth = groupNode.width || gridWidth;
                    //         fixedWidth = true;
                    //     }
                    //     maxHeight = Math.max(6, +height + 1);
                    // } else {
                    //     gridWidth = Math.max(12, +width);
                    //     maxWidth = gridWidth;
                    //     maxHeight = 1;
                    //     fixedHeight = true;
                    // }

                    var pos = $(this).offset();
                    var container = $('<div>')
                        .css({
                            position: 'absolute',
                            background: 'white',
                            padding: '5px 10px 10px 10px',
                            border: '1px solid grey',
                            zIndex: '20',
                            borderRadius: '4px',
                            display: 'none',
                        })
                        .appendTo(document.body);
                    var closeTimer;

                    container.on('mouseleave', function (evt) {
                        closeTimer = setTimeout(function () {
                            container.fadeOut(200, function () {
                                $(this).remove();
                            });
                        }, 100);
                    });
                    container.on('mouseenter', function () {
                        clearTimeout(closeTimer);
                    });

                    var label = $('<div>')
                        .css({
                            fontSize: '13px',
                            color: '#aaa',
                            float: 'left',
                            paddingTop: '1px',
                        })
                        .appendTo(container)
                        .text(
                            width === 0 && height === 0
                                ? auto_text
                                : width + (that.options.hasOwnProperty('height') ? ' x ' + height : '')
                        );
                    label.hover(
                        function () {
                            $(this).css('text-decoration', 'underline');
                        },
                        function () {
                            $(this).css('text-decoration', 'none');
                        }
                    );
                    label.click(function (e) {
                        // var group = $(that.options.group).val();
                        // var groupNode = null;
                        // if (group) {
                        //     groupNode = RED.nodes.node(group);
                        //     if (groupNode === null) {
                        //         return;
                        //     }
                        // }
                        $(that).elementSizerByNum({
                            width: that.options.width,
                            height: that.options.height,
                            groupNode: groupNode,
                            pos: pos,
                            label: that.element,
                            has_height: that.options.hasOwnProperty('height'),
                        });
                        closeTimer = setTimeout(function () {
                            container.fadeOut(200, function () {
                                $(this).remove();
                            });
                        }, 100);
                    });

                    var buttonRow = $('<div>', { style: 'text-align:right; height:25px;' }).appendTo(container);

                    if (hasAuto) {
                        var button = $('<a>', {
                            href: '#',
                            class: 'editor-button editor-button-small',
                            style: 'margin-bottom:5px',
                        })
                            .text(auto_text)
                            .appendTo(buttonRow)
                            .on('mouseup', function (evt) {
                                that.element.text(auto_text);
                                $(that.options.width).val(0).change();
                                $(that.options.height).val(0).change();
                                evt.preventDefault();
                                container.fadeOut(200, function () {
                                    $(this).remove();
                                });
                            });
                    }

                    var cellBorder = '1px dashed lightGray';
                    var cellBorderExisting = '1px solid gray';
                    var cellBorderHighlight = '1px dashed black';
                    var rows = [];
                    function addRow(i) {
                        var row = $('<div>')
                            .css({ padding: 0, margin: 0, height: '25px', 'box-sizing': 'border-box' })
                            .appendTo(container);
                        rows.push(row);
                        cells.push([]);
                        for (var j = 0; j < gridWidth; j++) {
                            addCell(i, j);
                        }
                    }
                    function addCell(i, j) {
                        var row = rows[i];
                        var cell = $('<div>')
                            .css({
                                display: 'inline-block',
                                width: '25px',
                                height: '25px',
                                borderRight: j === width - 1 && i < height ? cellBorderExisting : cellBorder,
                                borderBottom: i === height - 1 && j < width ? cellBorderExisting : cellBorder,
                                boxSizing: 'border-box',
                                cursor: 'pointer',
                                background: j < maxWidth ? '#fff' : '#eee',
                            })
                            .appendTo(row);
                        cells[i].push(cell);
                        if (j === 0) {
                            cell.css({ borderLeft: i <= height - 1 ? cellBorderExisting : cellBorder });
                        }
                        if (i === 0) {
                            cell.css({ borderTop: j <= width - 1 ? cellBorderExisting : cellBorder });
                        }
                        if (j < maxWidth) {
                            cell.data('w', j);
                            cell.data('h', i);
                            cell.on('mouseup', function () {
                                that.element.text(
                                    $(this).data('w') +
                                        1 +
                                        (that.options.hasOwnProperty('height') ? ' x ' + ($(this).data('h') + 1) : '')
                                );
                                $(that.options.width)
                                    .val($(this).data('w') + 1)
                                    .change();
                                $(that.options.height)
                                    .val($(this).data('h') + 1)
                                    .change();
                                container.fadeOut(200, function () {
                                    $(this).remove();
                                });
                            });
                            cell.on('mouseover', function () {
                                var w = $(this).data('w');
                                var h = $(this).data('h');
                                label.text(w + 1 + (that.options.hasOwnProperty('height') ? ' x ' + (h + 1) : ''));
                                for (var y = 0; y < maxHeight; y++) {
                                    for (var x = 0; x < maxWidth; x++) {
                                        cells[y][x].css({
                                            background: y <= h && x <= w ? '#ddd' : '#fff',
                                            borderLeft:
                                                x === 0 && y <= h
                                                    ? cellBorderHighlight
                                                    : x === 0
                                                    ? y <= height - 1
                                                        ? cellBorderExisting
                                                        : cellBorder
                                                    : '',
                                            borderTop:
                                                y === 0 && x <= w
                                                    ? cellBorderHighlight
                                                    : y === 0
                                                    ? x <= width - 1
                                                        ? cellBorderExisting
                                                        : cellBorder
                                                    : '',
                                            borderRight:
                                                x === w && y <= h
                                                    ? cellBorderHighlight
                                                    : x === width - 1 && y <= height - 1
                                                    ? cellBorderExisting
                                                    : cellBorder,
                                            borderBottom:
                                                y === h && x <= w
                                                    ? cellBorderHighlight
                                                    : y === height - 1 && x <= width - 1
                                                    ? cellBorderExisting
                                                    : cellBorder,
                                        });
                                    }
                                }
                                if (!fixedHeight && h === maxHeight - 1) {
                                    addRow(maxHeight++);
                                }
                                if (!fixedWidth && w === maxWidth - 1) {
                                    maxWidth++;
                                    gridWidth++;
                                    for (var r = 0; r < maxHeight; r++) {
                                        addCell(r, maxWidth - 1);
                                    }
                                }
                            });
                        }
                    }
                    var cells = [];
                    for (var i = 0; i < maxHeight; i++) {
                        addRow(i);
                    }
                    container.css({
                        top: pos.top + 'px',
                        left: pos.left + 'px',
                    });
                    container.fadeIn(200);
                });
            },
        });
    })(jQuery);
</script>

<script type="text/html" data-template-name="ur_base">
    <div class="form-row">
        This <i>ur_base</i> node is the main node that all<br />other dashboard widget nodes communicate to.<br />
        <br />One instance is required to support the dashboard.<br />
        <br />If you have no dashboard you can delete this node.<br />
        It will be re-created automatically if required.<br />
    </div>
</script>

<script type="text/html" data-help-name="ur_base"></script>
