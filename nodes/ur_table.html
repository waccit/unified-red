<script type="text/javascript">
    RED.nodes.registerType('ur_table', {
        category: 'unified-red',
        color: 'rgb(63, 173, 181)',
        defaults: {
            tab: { type: 'ur_tab', required: true },
            name: { value: '' },
            order: { value: 0 },
            width: {
                value: 0,
            },
            height: { value: 0 },
            fields: {
                value: [
                    {
                        label: '',
                        format: '',
                        formatType: '',
                        display: '',
                        device: '',
                        deviceType: '',
                        param: '',
                        unit: '',
                        unitType: '',
                    },
                ],
            },
            cts: { value: false },
            topicPattern: { value: '' },
            access: { value: '' },
            accessBehavior: { value: '' },
        },
        inputs: 1,
        outputs: 0,
        icon: 'font-awesome/fa-table',
        paletteLabel: 'table',
        label: function () {
            return this.name || 'table';
        },
        labelStyle: function () {
            return this.name ? 'node_label_italic' : '';
        },
        oneditprepare: function () {
            if (RED.nodes.getType('ur_tab')) {
                $('.form-tips').hide();
            } else {
                $('.form-row').hide();
            }
            $('#node-input-size').elementSizer({
                width: '#node-input-width',
            });
            $('#node-input-field-container')
                .css('min-height', '150px')
                .css('min-width', '950px')
                .editableList({
                    addItem: function (container, index, opt) {
                        if (!opt.hasOwnProperty('field')) {
                            opt.field = {};
                        }
                        var field = opt.field;
                        if (!field.hasOwnProperty('prop')) {
                            field.prop = 'vis';
                        }
                        container.css({
                            overflow: 'hidden',
                            whiteSpace: 'nowrap',
                        });
                        var row = $('<div/>').appendTo(container);
                        //label input
                        $('<input/>', {
                            class: 'node-input-field-label',
                            type: 'text',
                            placeholder: 'label',
                            style: 'margin-left: 5px; width: 15%;',
                        })
                            .appendTo(row)
                            .val(field.label);
                        //format select
                        var optionLink = { value: 'link', label: 'Link', hasValue: true };
                        var optionText = { value: 'fText', label: 'Text', hasValue: true };
                        $('<input/>', {
                            class: 'node-input-field-format',
                            type: 'text',
                            style: 'margin-left: 5px; width: 15%;',
                        })
                            .appendTo(row)
                            .val(field.format)
                            .change()
                            .typedInput({
                                default: field.formatType,
                                typeField: $('<input/>', { class: '.node-input-field-formatType', type: 'hidden' }),
                                types: [optionText, optionLink],
                            });
                        // Units select
                        var optionNothing = { value: 'nothing', label: 'No Units', hasValue: false };
                        var optionUnit = { value: 'unit', label: 'Units', hasValue: true };
                        $('<input/>', {
                            class: 'node-input-field-unit',
                            type: 'text',
                            style: 'margin-left: 5px; width: 15%;',
                        })
                            .appendTo(row)
                            .val(field.unit)
                            .change()
                            .typedInput({
                                default: field.unitType,
                                typeField: $('<input/>', { class: '.node-input-field-unitType', type: 'hidden' }),
                                types: [optionNothing, optionUnit],
                            });
                        //display input
                        $('<input/>', {
                            class: 'node-input-field-display',
                            type: 'text',
                            placeholder: 'display',
                            style: 'margin-left: 5px; width: 15%;',
                        })
                            .appendTo(row)
                            .val(field.display);
                        //Regex Select
                        var optionWebApp = { value: 'webApp', label: 'Smart Server IoT', hasValue: false };
                        var optionCustom = { value: 'custom', label: 'Custom', hasValue: true };
                        $('<input/>', {
                            class: 'node-input-field-device',
                            type: 'text',
                            style: 'margin-left: 5px; width: 15%;',
                        })
                            .appendTo(row)
                            .val(field.device)
                            .change()
                            .typedInput({
                                default: field.deviceType,
                                typeField: $('<input/>', { class: '.node-input-field-deviceType', type: 'hidden' }),
                                types: [optionWebApp, optionCustom],
                            });
                        //param input
                        $('<input/>', {
                            class: 'node-input-field-param',
                            type: 'text',
                            placeholder: 'param',
                            style: 'margin-left: 5px; width: 15%;',
                        })
                            .appendTo(row)
                            .val(field.param);
                    },
                    sortable: true,
                    removable: true,
                    addButton: true,
                });
            // $("#node-input-field-container").editableList('addItems', this.fields);
            for (let i = 0; i < this.fields.length; i++) {
                $('#node-input-field-container').editableList('addItem', { field: this.fields[i] });
            }
        },
        oneditsave: function () {
            let fields = $('#node-input-field-container').editableList('items');
            let node = this;
            node.fields = [];
            fields.each(function (i) {
                let container = $(this);

                let c = {
                    label: container.find('.node-input-field-label').val(),
                    format: container.find('.node-input-field-format').val(),
                    formatType: container.find('.node-input-field-format').typedInput('type'),
                    display: container.find('.node-input-field-display').val(),
                    deviceType: container.find('.node-input-field-device').typedInput('type'),
                    device: container.find('.node-input-field-device').val(),
                    param: container.find('.node-input-field-param').val(),
                    unitType: container.find('.node-input-field-unit').typedInput('type'),
                    unit: container.find('.node-input-field-unit').val(),
                };
                node.fields.push(c);
            });
            //check for pivot
            $('#node-input-cts').is(':checked') ? (this.pivot = 1) : (this.pivot = 0);
        },
        oneditresize: function (size) {
            var rows = $('#dialog-form>div:not(.node-input-field-container-row)');
            var height = size.height;
            for (var i = 0; i < rows.length; i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $('#dialog-form>div.node-input-field-container-row');
            height -= parseInt(editorRow.css('marginTop')) + parseInt(editorRow.css('marginBottom'));

            $('#node-input-field-container').editableList('height', height);
        },
    });
</script>

<script type="text/html" data-template-name="ur_table">
    <div class='form-row' id='table-row-tab'>
        <label for='node-input-tab'>
            <i class='fa fa-columns'></i> Tab</span>
        </label>
        <input type='text' id='node-input-tab'>
    </div>
    <div class="form-row" id="table-row-size">
        <label><i class="fa fa-object-group"></i> Size</label>
        <input type="hidden" id="node-input-width">
        <button class="editor-button" id="node-input-size"></button>
    </div>
    <div class='form-row'>
        <label for='node-input-name'>
            <i class='fa fa-tag'></i> <span data-i18n='node-red:common.label.name'></span>
        </label>
        <input type='text' id='node-input-name' data-i18n='[placeholder]node-red:common.label.name'>
    </div>
    <div class="form-row node-input-field-container-row">
        <label for="node-input-width" style="vertical-align:top"><i class="fa fa-list-alt"></i> Fields</label>
        <span style="float:right">
            <span data-i18n='table.label.send'>Pivot Table </span><input type="checkbox" id="node-input-cts" style="display:inline-block; width:auto; vertical-align:top;">
        </span>

        <div class="form-row node-input-field-container-row">
            <ol id="node-input-field-container"></ol>
        </div>
        <!-- <ol id="node-input-field-container"></ol> -->
    </div>
    <div class="form-row" id="topic-pattern">
        <label for="node-input-topicPattern" style="display: inline-flex; align-items: center"
            ><i class="fa fa-cogs" style="margin-right: 5px;"></i> Topic Pattern</label
        >
        <input type="text" id="node-input-topicPattern" />
    </div>
    <div class="form-row">
        <label for="node-input-access"><i class="fa fa-lock"></i> Access</label>
        <select id="node-input-access" style="width: 35%">
            <option value="">Default</option>
            <option value="1">Level 1 Viewer</option>
            <option value="2">Level 2 Limited Operator</option>
            <option value="3">Level 3 Standard Operator</option>
            <option value="4">Level 4 IT Operator</option>
            <option value="5">Level 5 Security Operator</option>
            <option value="6">Level 6 (reserved)</option>
            <option value="7">Level 7 (reserved)</option>
            <option value="8">Level 8 (reserved)</option>
            <option value="9">Level 9 Tech</option>
            <option value="10">Level 10 Admin</option>
         </select>
         <select id="node-input-accessBehavior" style="width: 35%">
            <option value="hide">Show/Hide</option>
            <option value="disable">Enable/Disable</option>
         </select>
    </div>
</script>

<script type="text/html" data-help-name="ur_table">
    <p>The table widget will generate a table element.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload<span class="property-type">string</span></dt>
        <dd>updates the table based on provided <b>Rules</b></dd>
        <dt>topic <span class="property-type">string</span></dt>
        <dd>the MQTT topic used to filter the msg</dd>
        
    </dl>
    <h3>Details</h3>
    <p><b>Label</b> is the field header label.  It is a simple static string and will be display on the
    page exactly as provided.<p>
    <p><b>Format</b> defines how the data is to display.</p>
    <b>For exapmple:</b>
    <ul>
        <li>Using <code>{x}</code> will display the <code>payload</code> as is comes in.</li>
        <li>Using math operations (+, -, *, /) changes the <code>payload</code> as shown below:
            <pre style="font-size:smaller;">1 + {x} / 100<br>{x} * 100<br>{x} + 100</pre>
        </li>
        <li>String formatting changes the definition of an object as shown below:
            <pre style="font-size:smaller;">{"0": "Offline","1": "Cooling","2": "Economizer","3": "Reheat"}</pre></li>
    </ul>
    <p><b>Link format</b> generates a redirect link with the input text.</p>
    <p><b>Units</b> defines what units are being used.</p>
    <b>For example</b>
    <ul>
        <li><code>Units</code> appends units in the input text to the <code>payload</code>.</li>
        <li><code>No Units</code> appends nothing to the <code>payload</code>.</li>
    </ul>
    <p><b>Display</b> defines what part of the message to display.</p>
    <ul>
        <li>Use <code>payload</code> in the input text to dispay the payload of <code>msg.payload</code>. Any child of  
            <code>msg.payload</code> can be displayed by using <code>msg.payload.{child}</code>.</li>
    </ul>
    <p><b>Device Filter</b> defines how we filter for each device.</p>
    <ul>
        <li>Using <code>Smart Server IoT</code> filters out the topic of the messgaes 
        for each of the devices on the Smart Server IoT topics.</li>
        <li>Using <code>Custom</code> allows you to write a unique regex expresison to filter out the incoming topic.</li>
    </ul>
    <p><b>Parameter</b> is the point definition that filters the table rows or element in payload.<p>
    
    
</script>